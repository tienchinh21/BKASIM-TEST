@{
    ViewData["Title"] = "Quản lý Trường Tùy Chỉnh";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var tabId = ViewBag.TabId as string;
}

<style>
    .field-card {
        border-left: 4px solid #0d6efd;
        transition: all 0.3s ease;
    }

    .field-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .field-type-badge {
        display: inline-block;
        background-color: #e7f3ff;
        color: #0d6efd;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .required-badge {
        display: inline-block;
        background-color: #ffe7e7;
        color: #dc3545;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .drag-handle {
        cursor: grab;
        color: #6c757d;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    .sortable-list {
        list-style: none;
        padding: 0;
    }

    .sortable-item {
        padding: 12px;
        margin-bottom: 8px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sortable-item.ui-sortable-helper {
        opacity: 0.7;
        background-color: #f8f9fa;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-group-sm .btn {
        padding: 4px 8px;
        font-size: 12px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .field-options-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }

    .option-tag {
        background-color: #f0f0f0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
    }

    .field-type-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0;
        border-radius: 6px;
        font-size: 16px;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-3">Quản lý Trường Tùy Chỉnh</h4>
                <p class="mb-0 text-muted">Thêm và quản lý các trường thông tin trong tab này</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/CustomFieldTab/Index?groupId=@(ViewBag.GroupId ?? "")" class="btn btn-secondary">
                    <i class="ri-arrow-left-line me-2"></i>
                    Quay lại
                </a>
                <button class="btn btn-primary" onclick="openCreateFieldModal()">
                    <i class="ri-add-line me-2"></i>
                    Thêm Trường Mới
                </button>
            </div>
        </div>
    </div>

    <!-- Fields List -->
    <div class="col-lg-12">
        <div id="fieldsList" class="sortable-list">
            <!-- Fields will be loaded here -->
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="ri-inbox-line"></i>
            <p>Chưa có trường nào. Hãy thêm trường đầu tiên!</p>
        </div>
    </div>
</div>

<!-- Create/Edit Field Modal -->
<div class="modal fade" id="fieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldModalTitle">
                    <i class="ri-file-add-line me-2"></i>
                    Tạo Trường Mới
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="fieldForm">
                    <input type="hidden" id="fieldId" />
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fieldName" class="form-label">
                                Tên Trường <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="fieldName" placeholder="VD: Họ và tên, Email..." maxlength="100" required />
                            <div class="form-text">Tối đa 100 ký tự</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="fieldType" class="form-label">
                                Loại Trường <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="fieldType" required onchange="updateFieldTypeOptions()">
                                <option value="">-- Chọn loại trường --</option>
                                <option value="1">Text (Văn bản)</option>
                                <option value="8">Email</option>
                                <option value="9">Số điện thoại</option>
                                <option value="7">Văn bản dài</option>
                                <option value="6">Ngày giờ</option>
                                <option value="7">Ngày</option>
                                <option value="2">Số nguyên</option>
                                <option value="3">Số thập phân</option>
                                <option value="5">Boolean (Có/Không)</option>
                                <option value="10">URL</option>
                                <option value="12">Dropdown (Chọn một)</option>
                                <option value="13">Multiple Choice (Chọn nhiều)</option>
                                <option value="14">File</option>
                                <option value="15">Hình ảnh</option>
                            </select>
                        </div>
                    </div>

                    <!-- Field Options (for Dropdown/MultipleChoice) -->
                    <div id="optionsSection" style="display: none;" class="mb-3">
                        <label for="fieldOptions" class="form-label">
                            Các Tùy Chọn <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="fieldOptions" rows="4" placeholder="Nhập mỗi tùy chọn trên một dòng&#10;VD:&#10;Tùy chọn 1&#10;Tùy chọn 2&#10;Tùy chọn 3"></textarea>
                        <div class="form-text">Nhập mỗi tùy chọn trên một dòng riêng</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isRequired" />
                                <label class="form-check-label" for="isRequired">
                                    <i class="ri-alert-line me-1"></i>
                                    Trường bắt buộc
                                </label>
                            </div>
                            <div class="form-text">Người dùng phải điền trường này</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="displayOrder" class="form-label">
                                Thứ tự hiển thị
                            </label>
                            <input type="number" class="form-control" id="displayOrder" min="0" value="0" />
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="ri-information-line me-2"></i>
                        <strong>Lưu ý:</strong> Các trường có thể được sắp xếp lại bằng cách kéo thả sau khi tạo.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="saveField()">
                    <i class="ri-save-line me-1"></i>
                    Lưu Trường
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="ri-alert-line me-2"></i>
                    Xác nhận xóa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa trường <strong id="deleteFieldName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="ri-alert-fill me-2"></i>
                    <strong>Lưu ý:</strong> Trường sẽ bị xóa nhưng các giá trị đã gửi sẽ được lưu giữ với tên trường được lưu trữ.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteField()">
                    <i class="ri-delete-bin-line me-1"></i>
                    Xóa Trường
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <script>
        let tabId = '@tabId';
        let currentEditingFieldId = null;
        let currentDeletingFieldId = null;

        const fieldTypeMap = {
            '1': 'Text',
            '2': 'Integer',
            '3': 'Decimal',
            '5': 'Boolean',
            '6': 'DateTime',
            '7': 'LongText',
            '8': 'Email',
            '9': 'PhoneNumber',
            '10': 'URL',
            '12': 'Dropdown',
            '13': 'MultipleChoice',
            '14': 'File',
            '15': 'Image'
        };

        const fieldTypeIcons = {
            '1': '<i class="ri-text-line"></i>',
            '2': '<i class="ri-numbers-line"></i>',
            '3': '<i class="ri-calculator-line"></i>',
            '5': '<i class="ri-checkbox-line"></i>',
            '6': '<i class="ri-calendar-event-line"></i>',
            '7': '<i class="ri-file-text-line"></i>',
            '8': '<i class="ri-mail-line"></i>',
            '9': '<i class="ri-phone-line"></i>',
            '10': '<i class="ri-link-line"></i>',
            '12': '<i class="ri-list-check-line"></i>',
            '13': '<i class="ri-checkbox-multiple-line"></i>',
            '14': '<i class="ri-file-line"></i>',
            '15': '<i class="ri-image-line"></i>'
        };

        $(document).ready(function () {
            loadFields();
            initSortable();
        });

        function loadFields() {
            $.ajax({
                url: '/CustomField/GetFieldsByTab',
                type: 'GET',
                data: { tabId: tabId },
                success: function (response) {
                    if (response.success && response.data.length > 0) {
                        displayFields(response.data);
                        $('#emptyState').hide();
                    } else {
                        $('#fieldsList').empty();
                        $('#emptyState').show();
                    }
                },
                error: function () {
                    showError('Lỗi', 'Không thể tải danh sách trường');
                }
            });
        }

        function displayFields(fields) {
            const fieldsList = $('#fieldsList');
            fieldsList.empty();

            fields.forEach((field, index) => {
                const typeLabel = fieldTypeMap[field.fieldType] || 'Unknown';
                const typeIcon = fieldTypeIcons[field.fieldType] || '<i class="ri-question-line"></i>';
                const requiredBadge = field.isRequired ? '<span class="required-badge ms-2"><i class="ri-alert-line me-1"></i>Bắt buộc</span>' : '';
                
                let optionsPreview = '';
                if (field.fieldOptions && field.fieldOptions.length > 0) {
                    optionsPreview = `
                        <div class="field-options-preview">
                            ${field.fieldOptions.slice(0, 3).map(opt => `<span class="option-tag">${escapeHtml(opt)}</span>`).join('')}
                            ${field.fieldOptions.length > 3 ? `<span class="option-tag">+${field.fieldOptions.length - 3} khác</span>` : ''}
                        </div>
                    `;
                }

                const fieldHtml = `
                    <div class="sortable-item field-card" data-field-id="${field.id}">
                        <i class="ri-drag-move-line drag-handle"></i>
                        <div class="field-type-icon">
                            ${typeIcon}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2">
                                <h6 class="mb-0">${escapeHtml(field.fieldName)}</h6>
                                <span class="field-type-badge">${typeLabel}</span>
                                ${requiredBadge}
                            </div>
                            ${optionsPreview}
                            <small class="text-muted">Thứ tự: ${field.displayOrder}</small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="openEditFieldModal('${field.id}', '${escapeHtml(field.fieldName)}', '${field.fieldType}', '${field.isRequired}', '${field.displayOrder}', '${JSON.stringify(field.fieldOptions || []).replace(/"/g, '&quot;')}')">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="openDeleteConfirm('${field.id}', '${escapeHtml(field.fieldName)}')">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                `;
                fieldsList.append(fieldHtml);
            });
        }

        function initSortable() {
            $('#fieldsList').sortable({
                items: '.sortable-item',
                handle: '.drag-handle',
                placeholder: 'sortable-placeholder',
                update: function () {
                    saveSortOrder();
                }
            });
        }

        function saveSortOrder() {
            const fields = [];
            $('#fieldsList .sortable-item').each(function () {
                fields.push({
                    fieldId: $(this).data('field-id')
                });
            });

            $.ajax({
                url: '/CustomField/ReorderFields',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tabId: tabId,
                    fields: fields
                }),
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', 'Sắp xếp trường thành công');
                    } else {
                        showError('Lỗi', response.message);
                        loadFields();
                    }
                },
                error: function () {
                    showError('Lỗi', 'Không thể sắp xếp trường');
                    loadFields();
                }
            });
        }

        function updateFieldTypeOptions() {
            const fieldType = $('#fieldType').val();
            const optionsSection = $('#optionsSection');
            
            if (fieldType === '12' || fieldType === '13') {
                optionsSection.show();
                $('#fieldOptions').prop('required', true);
            } else {
                optionsSection.hide();
                $('#fieldOptions').prop('required', false);
            }
        }

        function openCreateFieldModal() {
            currentEditingFieldId = null;
            $('#fieldId').val('');
            $('#fieldName').val('');
            $('#fieldType').val('');
            $('#fieldOptions').val('');
            $('#isRequired').prop('checked', false);
            $('#displayOrder').val('0');
            $('#fieldModalTitle').html('<i class="ri-file-add-line me-2"></i>Tạo Trường Mới');
            $('#optionsSection').hide();
            $('#fieldModal').modal('show');
            $('#fieldName').focus();
        }

        function openEditFieldModal(fieldId, fieldName, fieldType, isRequired, displayOrder, fieldOptions) {
            currentEditingFieldId = fieldId;
            $('#fieldId').val(fieldId);
            $('#fieldName').val(fieldName);
            $('#fieldType').val(fieldType);
            $('#isRequired').prop('checked', isRequired === 'true' || isRequired === true);
            $('#displayOrder').val(displayOrder);
            
            try {
                const options = JSON.parse(fieldOptions);
                $('#fieldOptions').val(options.join('\n'));
            } catch (e) {
                $('#fieldOptions').val('');
            }
            
            updateFieldTypeOptions();
            $('#fieldModalTitle').html('<i class="ri-edit-line me-2"></i>Chỉnh sửa Trường');
            $('#fieldModal').modal('show');
            $('#fieldName').focus();
        }

        function saveField() {
            const fieldName = $('#fieldName').val().trim();
            const fieldType = $('#fieldType').val();
            const isRequired = $('#isRequired').is(':checked');
            const displayOrder = parseInt($('#displayOrder').val()) || 0;

            if (!fieldName) {
                showError('Lỗi', 'Tên trường không được để trống');
                return;
            }

            if (!fieldType) {
                showError('Lỗi', 'Loại trường không được để trống');
                return;
            }

            let fieldOptions = null;
            if (fieldType === '12' || fieldType === '13') {
                const optionsText = $('#fieldOptions').val().trim();
                if (!optionsText) {
                    showError('Lỗi', 'Các tùy chọn không được để trống');
                    return;
                }
                fieldOptions = optionsText.split('\n').map(o => o.trim()).filter(o => o);
            }

            const isCreate = !currentEditingFieldId;
            const url = isCreate ? '/CustomField/CreateField' : '/CustomField/UpdateField';
            const method = isCreate ? 'POST' : 'PUT';

            const data = {
                id: currentEditingFieldId,
                fieldName: fieldName,
                fieldType: parseInt(fieldType),
                customFieldTabId: tabId,
                entityType: 1, // GroupMembership
                entityId: '', // Will be set by service
                isRequired: isRequired,
                displayOrder: displayOrder,
                fieldOptions: fieldOptions
            };

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message);
                        $('#fieldModal').modal('hide');
                        loadFields();
                    } else {
                        showError('Lỗi', response.message);
                    }
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi lưu trường');
                }
            });
        }

        function openDeleteConfirm(fieldId, fieldName) {
            currentDeletingFieldId = fieldId;
            $('#deleteFieldName').text(fieldName);
            $('#deleteConfirmModal').modal('show');
        }

        function confirmDeleteField() {
            if (!currentDeletingFieldId) return;

            $.ajax({
                url: `/CustomField/DeleteField?fieldId=${currentDeletingFieldId}`,
                type: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message);
                        $('#deleteConfirmModal').modal('hide');
                        loadFields();
                    } else {
                        showError('Lỗi', response.message);
                    }
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi xóa trường');
                }
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
}
