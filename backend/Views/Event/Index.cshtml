@{

    ViewData["Title"] = "Quản Lý Sự Kiện";

    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Http
@using MiniAppGIBA.Constants;
@inject IHttpContextAccessor HttpContextAccessor
@{

    var canEdit = User?.IsInRole(CTRole.GIBA) == true;
}

<style>
    .table-success {
        background-color: rgba(25, 135, 84, 0.1);
    }


    .table-danger {
        background-color: rgba(220, 53, 69, 0.1);
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-success {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .status-secondary {
        background-color: #e2e3e5;
        color: #41464b;
    }

    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
    }

    /* Style cho dropdown filter - giới hạn chiều cao và cho phép scroll */
    .custom-select-wrapper {
        position: relative;
    }

    .custom-select-scrollable {
        width: 100%;
    }

    /* Style cho select khi có size attribute (khi mở với scroll) */
    .custom-select-scrollable[size],
    .form-select[size],
    .form-control[size] {
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: calc(1.5rem * 5 + 0.75rem * 2);
        /* 5 dòng + padding */
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Custom scrollbar cho dropdown */
    .custom-select-scrollable::-webkit-scrollbar,
    .form-select::-webkit-scrollbar,
    .form-control::-webkit-scrollbar {
        width: 6px;
    }

    .custom-select-scrollable::-webkit-scrollbar-track,
    .form-select::-webkit-scrollbar-track,
    .form-control::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .custom-select-scrollable::-webkit-scrollbar-thumb,
    .form-select::-webkit-scrollbar-thumb,
    .form-control::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .custom-select-scrollable::-webkit-scrollbar-thumb:hover,
    .form-select::-webkit-scrollbar-thumb:hover,
    .form-control::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Style cho options */
    .custom-select-scrollable option,
    .form-select option,
    .form-control option {
        padding: 8px 12px;
        line-height: 1.5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-3">Quản Lý Sự Kiện</h4>
                <p class="mb-0 text-muted">Quản lý các sự kiện trong hệ thống</p>
            </div>

            <div class="d-flex align-items-center justify-content-between">
                @if (canEdit)

                {
                    <a class="btn btn-primary shadow-sm" href="#" onclick="openCreateModal(); return false;">
                        <i class="ri-add-line me-2"></i>
                        Tạo Sự Kiện
                    </a>

                }
            </div>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="ri-filter-3-line me-2"></i>
                    Bộ lọc tìm kiếm
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Thanh tìm kiếm -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Tìm kiếm</label>
                            <div class="input-group">
                                <input id="search" type="text" class="form-control"
                                    placeholder="Tìm theo tên sự kiện..." />
                                <button class="btn btn-primary" onclick="eventsTable.ajax.reload()">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bộ lọc hội nhóm -->
                    <div class="col-md-3">
                        <label class="form-label">Hội nhóm</label>
                        <select id="filter-group" class="form-select" onchange="eventsTable.ajax.reload()">
                            <option value="">Tất cả hội nhóm</option>
                            @if (ViewBag.Groups != null)

                            {
                                @foreach (var group in ViewBag.Groups)

                                {
                                    <option value="@group.Id">@group.GroupName</option>

                                }

                            }
                        </select>
                    </div>

                    <!-- Bộ lọc loại sự kiện -->
                    <div class="col-md-2">
                        <label class="form-label">Loại sự kiện</label>
                        <select id="filter-type" class="form-select" onchange="eventsTable.ajax.reload()">
                            <option value="">Tất cả loại</option>
                            <option value="1">Nội bộ</option>
                            <option value="2">Công khai</option>
                        </select>
                    </div>

                    <!-- Bộ lọc trạng thái -->
                    <div class="col-md-2">
                        <label class="form-label">Trạng thái</label>
                        <select id="filter-status" class="form-select" onchange="eventsTable.ajax.reload()">
                            <option value="">Tất cả trạng thái</option>
                            <option value="1">Sắp diễn ra</option>
                            <option value="2">Đang diễn ra</option>
                            <option value="3">Đã kết thúc</option>
                        </select>
                    </div>

                    <!-- Nút lọc và xuất excel -->
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light border flex-fill" onclick="resetFilters()">
                                <i class="ri-refresh-line me-1"></i>
                                Đặt lại
                            </button>
                            <button class="btn btn-primary flex-fill" onclick="eventsTable.ajax.reload()">
                                <i class="ri-filter-line me-1"></i>
                                Lọc
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bảng dữ liệu -->
    <div class="col-lg-12">
        <div class="table-responsive rounded mb-3">
            <table id="list-events" class="data-table table mb-0 tbl-server-info"></table>
        </div>
    </div>
</div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa sự kiện này không?</p>
                <p class="text-muted small">Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="ri-calendar-event-line me-2"></i>
                    Quản Lý Sự Kiện
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
<script>
    // Override showSuccess and showError to use SweetAlert 2.x (Swal.fire) instead of SweetAlert 1.x (swal)
    // This prevents the "Class constructor Un cannot be invoked without 'new'" error
    // Use IIFE to ensure this runs immediately and cannot be overridden
    (function () {
        'use strict';

        // Override with SweetAlert 2.x implementations
        window.showSuccess = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Thành công',
                    text: message || '',
                    icon: 'success',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3085d6',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                alert((title || 'Thành công') + ': ' + (message || ''));
            }
        };

        window.showError = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Lỗi',
                    text: message || '',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#d33'
                });
            } else {
                alert((title || 'Lỗi') + ': ' + (message || ''));
            }
        };

        window.showWarning = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Cảnh báo',
                    text: message || '',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#f0ad4e'
                });
            } else {
                alert((title || 'Cảnh báo') + ': ' + (message || ''));
            }
        };
    })();

    var eventsTable;
    var deleteId;
    let searchTimeout; // Declare timeout variable outside function

    // Re-override after document ready to ensure it's not overridden by other scripts
    $(document).ready(function () {
        // Override again to ensure it's not overridden by _Layout.cshtml or other scripts
        window.showSuccess = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Thành công',
                    text: message || '',
                    icon: 'success',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3085d6',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                alert((title || 'Thành công') + ': ' + (message || ''));
            }
        };

        window.showError = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Lỗi',
                    text: message || '',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#d33'
                });
            } else {
                alert((title || 'Lỗi') + ': ' + (message || ''));
            }
        };

        window.showWarning = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Cảnh báo',
                    text: message || '',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#f0ad4e'
                });
            } else {
                alert((title || 'Cảnh báo') + ': ' + (message || ''));
            }
        };

        // Initialize table and search
        GetListEvents();
        $('#search').on('input', handleSearchInput);

        // Setup scroll for all filter dropdowns
        setupSelectScroll(document.getElementById('filter-group'));
        setupSelectScroll(document.getElementById('filter-type'));
        setupSelectScroll(document.getElementById('filter-status'));
    });

    function setupSelectScroll(selectElement) {
        if (!selectElement) return;

        const maxVisibleOptions = 5;
        const totalOptions = selectElement.options.length;

        // Nếu có nhiều hơn 5 options, thêm event để hiển thị scroll
        if (totalOptions > maxVisibleOptions) {
            // Khi focus, set size để hiển thị scroll
            $(selectElement).on('focus', function () {
                if (this.size === 0 || this.size === 1) {
                    this.size = Math.min(maxVisibleOptions, totalOptions);
                    this.style.position = 'relative';
                    this.style.zIndex = '1000';
                }
            });

            // Khi blur, reset về dropdown bình thường
            $(selectElement).on('blur', function () {
                this.size = 0;
                this.style.position = '';
                this.style.zIndex = '';
            });

            // Khi change, reset size
            $(selectElement).on('change', function () {
                setTimeout(() => {
                    this.size = 0;
                    this.style.position = '';
                    this.style.zIndex = '';
                }, 100);
            });
        }
    }

    function GetListEvents() {
        eventsTable = new DataTable("#list-events", {
            searching: false,
            sort: false,
            responsive: true,
            pageLength: 10,
            serverSide: true,
            ajax: function (data, callback, settings) {
                const page = (data.start / data.length) + 1;
                const groupId = $("#filter-group").val();
                const type = $("#filter-type").val();
                const status = $("#filter-status").val();
                let keyword = $("#search").val();
                let isUser = false;
                $.ajax({
                    url: '/Event/GetPage',
                    type: 'GET',
                    data: {
                        page: page,
                        pageSize: data.length,
                        keyword: keyword,
                        groupId: groupId,
                        type: type,
                        status: status,
                        isUser: isUser
                    },
                    success: function (response) {
                        console.log('API Response:', response);
                        const formattedData = response.data.map((item, index) => ({
                            index: data.start + index + 1,
                            title: `<div class="d-flex flex-column">
                                                                                        <h6 class="mb-1">${item.title}</h6>
                                                                                        <small class="text-muted">${item.groupName}</small>
                                                                                    </div>`,
                            timeRange: `<div class="text-center">
                                                                                            <div class="fw-semibold">${item.startTime}</div>
                                                                                            <small class="text-muted">đến</small>
                                                                                            <div class="fw-semibold">${item.endTime}</div>
                                                                                        </div>`,
                            type: `<span class="badge ${item.type === 1 ? 'bg-info' : 'bg-success'}">${item.typeText}</span>`,
                            status: `<span class="status-badge status-${item.statusClass}">${item.statusText}</span>`,
                            joinCount: `<span class="badge bg-primary">${item.joinCount} người</span>`,
                            isActive: item.isActive
                                ? '<span class="badge bg-success">Hoạt động</span>'
                                : '<span class="badge bg-secondary">Không hoạt động</span>',
                            createdDate: item.createdDate,
                            actions: `<div class="d-flex align-items-center justify-content-center gap-1">
                                                                                        ${item.status === 3 ? `<a href="/Event/Statistics/${item.id}"
                                                                                                class="btn btn-sm btn-outline-info" title="Thống Kê">
                                                                                            <i class="ri-bar-chart-line"></i>
                                                                                        </a>` : ''}
                                                                                        <button onclick="openCheckInPage('${item.id}')"
                                                                                                class="btn btn-sm btn-outline-success" title="Check-In">
                                                                                            <i class="ri-user-line"></i>
                                                                                        </button>
                                                                                        <button onclick="openEditModal('${item.id}')"
                                                                                                class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                                                                            <i class="ri-edit-line"></i>
                                                                                        </button>
                                                                                        <button onclick="confirmDelete('${item.id}')"
                                                                                                class="btn btn-sm btn-outline-danger" title="Xóa">
                                                                                            <i class="ri-delete-bin-line"></i>
                                                                                        </button>
                                                                                    </div>`
                        }));

                        console.log('Formatted Data:', formattedData);
                        callback({
                            draw: data.draw,
                            recordsTotal: response.recordsTotal,
                            recordsFiltered: response.recordsFiltered,
                            data: formattedData
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading data:', error);
                        console.error('Response:', xhr.responseText);
                        callback({
                            draw: data.draw,
                            recordsTotal: 0,
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                });
            },
            columns: [
                { title: "STT", data: "index", className: 'text-center', width: "60px" },
                { title: "Tên Sự Kiện", data: "title", className: 'col-3' },
                { title: "Thời Gian", data: "timeRange", className: 'text-center', width: "180px" },
                { title: "Loại", data: "type", className: 'text-center', width: "100px" },
                { title: "Trạng Thái", data: "status", className: 'text-center', width: "120px" },
                { title: "Tham Gia", data: "joinCount", className: 'text-center', width: "100px" },
                { title: "Hoạt Động", data: "isActive", className: 'text-center', width: "120px" },
                { title: "Ngày Tạo", data: "createdDate", className: 'text-center', width: "140px" },
                { title: "Thao Tác", data: "actions", className: 'text-center', width: "120px" }
            ],
            language: {
                "lengthMenu": "Hiển thị _MENU_ dòng mỗi trang",
                "zeroRecords": "Không tìm thấy kết quả",
                "info": "Hiển thị từ _START_ đến _END_ của _TOTAL_ dòng",
                "infoEmpty": "Không có dữ liệu",
                "infoFiltered": "(lọc từ tổng số _MAX_ dòng)"
            }
        });

        $(eventsTable.table().header()).addClass('ligth ligth-data');
    }

    function handleSearchInput() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            eventsTable.ajax.reload();
        }, 500);
    }

    function resetFilters() {
        $('#search').val('');
        $('#filter-group').val('');
        $('#filter-type').val('');
        $('#filter-status').val('');
        eventsTable.ajax.reload();
    }

    function confirmDelete(id) {
        deleteId = id;
        $('#deleteModal').modal('show');
    }

    $('#confirmDelete').click(function () {
        if (deleteId) {
            $.ajax({
                url: '/Event/Delete',
                type: 'POST',
                data: {
                    id: deleteId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message);
                        eventsTable.ajax.reload(null, false);
                    } else {
                        showError('Lỗi', response.message);
                    }
                    $('#deleteModal').modal('hide');
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi xóa sự kiện');
                    $('#deleteModal').modal('hide');
                }
            });
        }
    });

    function openEditModal(eventId) {
        try {
            console.log('openEditModal called with eventId:', eventId);

            // Load partial view edit vào modal
            $.get(`/Event/Edit/${eventId}`, function (data) {
                console.log('Edit form loaded successfully');

                $('#eventModal .modal-body').html(data);

                // Re-override showSuccess/showError after modal content is loaded
                overrideAlertFunctions();

                $('#eventModal').modal('show');

                console.log('Modal shown with edit form');
            }).fail(function (xhr, status, error) {
                console.error('Error loading edit form:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                showError('Lỗi', 'Không thể tải form chỉnh sửa sự kiện');
            });
        } catch (e) {
            console.error('Error in openEditModal:', e);
            showError('Lỗi', 'Có lỗi xảy ra');
        }
    }

    // Global function to get custom fields data (called from _EventForm.cshtml)
    function getCustomFieldsData() {
        const fields = [];
        $('.custom-field-item').each(function () {
            const fieldName = $(this).find('.custom-field-name').val()?.trim();
            const fieldType = $(this).find('.custom-field-type').val();
            const fieldValue = $(this).find('.custom-field-value').val()?.trim() || '';
            const isRequired = $(this).find('.custom-field-required').is(':checked');

            if (fieldName && fieldType) {
                fields.push({
                    FieldName: fieldName,
                    FieldType: parseInt(fieldType),
                    FieldValue: fieldValue,
                    IsRequired: isRequired
                });
            }
        });
        return fields;
    }

    function openCreateModal() {
        try {
            // Load partial view vào modal
            $.get('/Event/Create', function (data) {
                $('#eventModal .modal-body').html(data);

                // Re-override showSuccess/showError after modal content is loaded
                overrideAlertFunctions();

                $('#eventModal').modal('show');
            }).fail(function (xhr, status, error) {
                console.error('Error loading create form:', error);
                console.error('Response:', xhr.responseText);
                showError('Lỗi', 'Không thể tải form tạo sự kiện');
            });
        } catch (e) {
            console.error('Error in openCreateModal:', e);
            showError('Lỗi', 'Có lỗi xảy ra');
        }
    }

    // Helper function to override alert functions
    function overrideAlertFunctions() {
        window.showSuccess = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Thành công',
                    text: message || '',
                    icon: 'success',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3085d6',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                alert((title || 'Thành công') + ': ' + (message || ''));
            }
        };

        window.showError = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Lỗi',
                    text: message || '',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#d33'
                });
            } else {
                alert((title || 'Lỗi') + ': ' + (message || ''));
            }
        };

        window.showWarning = function (title, message) {
            if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: title || 'Cảnh báo',
                    text: message || '',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#f0ad4e'
                });
            } else {
                alert((title || 'Cảnh báo') + ': ' + (message || ''));
            }
        };
    }

    function openCheckInPage(eventId) {
        window.location.href = `/EventRegistrations/CheckIn/${eventId}`;
    }

    function submitEventForm(isEdit, eventId) {
        console.log('submitEventForm called - isEdit:', isEdit, 'eventId:', eventId);

        if (isEdit && !eventId) {
            console.error('Edit mode but eventId is missing!');
            showError('Lỗi', 'Không tìm thấy ID sự kiện');
            return;
        }

        const formData = new FormData();

        let content = '';
        if (window.quillEditor) {
            content = window.quillEditor.root.innerHTML;
        } else if ($('#eventModal').find('#content').length) {
            // Fallback to get content from the modal's Quill instance
            const modalQuill = $('#eventModal').find('#content')[0];
            if (modalQuill && modalQuill.__quill) {
                content = modalQuill.__quill.root.innerHTML;
            }
        }

        formData.append('Title', $('#title').val());
        formData.append('Content', content);
        formData.append('GroupId', $('#groupId').val());
        formData.append('StartTime', $('#startTime').val());
        formData.append('EndTime', $('#endTime').val());
        formData.append('Type', $('#type').val());
        formData.append('JoinCount', $('#joinCount').val() || -1);
        formData.append('MeetingLink', $('#meetingLink').val() || '');
        formData.append('GoogleMapURL', $('#googleMapURL').val() || '');
        formData.append('Address', $('#address').val() || '');
        formData.append('IsActive', $('#isActive').val() === 'true');
        formData.append('NeedApproval', $('#needApproval').val() === 'true');

        const sponsorId = $('#sponsorId').val();
        const sponsorshipTierId = $('#sponsorshipTierId').val();
        if (sponsorId && sponsorshipTierId) {
            formData.append('SponsorId', sponsorId);
            formData.append('SponsorshipTierId', sponsorshipTierId);
        }

        const bannerFile = $('#bannerFile')[0].files[0];
        if (bannerFile) {
            formData.append('BannerFile', bannerFile);
        }

        const imageFile = $('#imageFile')[0].files[0];
        if (imageFile) {
            formData.append('ImageFiles', imageFile);
        }

        const giftName = $('#giftName').val();
        const giftQuantity = $('#giftQuantity').val();
        const giftImageFile = $('#giftImageFile')[0].files[0];

        if (giftName && giftQuantity) {
            const gift = {
                GiftName: giftName,
                Quantity: parseInt(giftQuantity),
                ImageIndex: 0
            };

            formData.append('GiftsData', JSON.stringify([gift]));

            if (giftImageFile) {
                formData.append('GiftImages', giftImageFile);
            }
        }

        // Custom Fields Data - Always send, even if empty array
        const customFields = getCustomFieldsData();
        formData.append('CustomFieldsData', JSON.stringify(customFields || []));

        formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

        if (isEdit) {
            formData.append('Id', eventId);
            console.log('Appending Id to formData:', eventId);
        }

        const url = isEdit ? '/Event/Edit' : '/Event/Create';
        console.log('Submitting to URL:', url);

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                console.log('API Response:', response);
                if (response.success) {
                    showSuccess('Thành công', response.message);
                    $('#eventModal').modal('hide');
                    eventsTable.ajax.reload();
                } else {
                    showError('Lỗi', response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('API Error:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                showError('Lỗi', 'Có lỗi xảy ra khi lưu sự kiện: ' + error);
            }
        });
    }
</script>
}
