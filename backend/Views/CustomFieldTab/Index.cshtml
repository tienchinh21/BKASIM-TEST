@{
    ViewData["Title"] = "Quản lý Tab Trường Tùy Chỉnh";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var groupId = ViewBag.GroupId as string;
}

<style>
    .tab-card {
        border-left: 4px solid #0d6efd;
        transition: all 0.3s ease;
    }

    .tab-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .tab-card.active {
        border-left-color: #198754;
        background-color: #f0f9ff;
    }

    .field-count-badge {
        display: inline-block;
        background-color: #e7f3ff;
        color: #0d6efd;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .drag-handle {
        cursor: grab;
        color: #6c757d;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    .sortable-list {
        list-style: none;
        padding: 0;
    }

    .sortable-item {
        padding: 12px;
        margin-bottom: 8px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sortable-item.ui-sortable-helper {
        opacity: 0.7;
        background-color: #f8f9fa;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-group-sm .btn {
        padding: 4px 8px;
        font-size: 12px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-3">Quản lý Tab Trường Tùy Chỉnh</h4>
                <p class="mb-0 text-muted">Tổ chức các trường thông tin theo chủ đề (tab) cho biểu mẫu đăng ký thành viên</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateTabModal()">
                <i class="ri-add-line me-2"></i>
                Thêm Tab Mới
            </button>
        </div>
    </div>

    <!-- Tabs List -->
    <div class="col-lg-12">
        <div id="tabsList" class="sortable-list">
            <!-- Tabs will be loaded here -->
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="ri-inbox-line"></i>
            <p>Chưa có tab nào. Hãy tạo tab đầu tiên để bắt đầu!</p>
        </div>
    </div>
</div>

<!-- Create/Edit Tab Modal -->
<div class="modal fade" id="tabModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tabModalTitle">
                    <i class="ri-folder-add-line me-2"></i>
                    Tạo Tab Mới
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="tabForm">
                    <input type="hidden" id="tabId" />
                    
                    <div class="mb-3">
                        <label for="tabName" class="form-label">
                            Tên Tab <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="tabName" placeholder="VD: Thông tin cơ bản, Kinh nghiệm..." maxlength="100" required />
                        <div class="form-text">Tối đa 100 ký tự</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="ri-information-line me-2"></i>
                        <strong>Lưu ý:</strong> Tab được sử dụng để tổ chức các trường thông tin theo chủ đề. Bạn có thể thêm các trường vào tab sau khi tạo.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="saveTab()">
                    <i class="ri-save-line me-1"></i>
                    Lưu Tab
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="ri-alert-line me-2"></i>
                    Xác nhận xóa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa tab <strong id="deleteTabName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="ri-alert-fill me-2"></i>
                    <strong>Cảnh báo:</strong> Tất cả các trường trong tab này cũng sẽ bị xóa. Tuy nhiên, các giá trị đã gửi sẽ được lưu giữ.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTab()">
                    <i class="ri-delete-bin-line me-1"></i>
                    Xóa Tab
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <script>
        let groupId = '@groupId';
        let currentEditingTabId = null;
        let currentDeletingTabId = null;

        $(document).ready(function () {
            loadTabs();
            initSortable();
        });

        function loadTabs() {
            $.ajax({
                url: '/CustomFieldTab/GetTabs',
                type: 'GET',
                data: { groupId: groupId },
                success: function (response) {
                    if (response.success && response.data.length > 0) {
                        displayTabs(response.data);
                        $('#emptyState').hide();
                    } else {
                        $('#tabsList').empty();
                        $('#emptyState').show();
                    }
                },
                error: function () {
                    showError('Lỗi', 'Không thể tải danh sách tab');
                }
            });
        }

        function displayTabs(tabs) {
            const tabsList = $('#tabsList');
            tabsList.empty();

            tabs.forEach((tab, index) => {
                const tabHtml = `
                    <div class="sortable-item tab-card" data-tab-id="${tab.id}">
                        <i class="ri-drag-move-line drag-handle"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2">
                                <h6 class="mb-0">${escapeHtml(tab.tabName)}</h6>
                                <span class="field-count-badge">
                                    <i class="ri-file-list-line me-1"></i>
                                    ${tab.fieldCount} trường
                                </span>
                            </div>
                            <small class="text-muted">Thứ tự: ${tab.displayOrder}</small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="openEditTabModal('${tab.id}', '${escapeHtml(tab.tabName)}')">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="manageFields('${tab.id}', '${escapeHtml(tab.tabName)}')">
                                <i class="ri-settings-line"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="openDeleteConfirm('${tab.id}', '${escapeHtml(tab.tabName)}')">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                `;
                tabsList.append(tabHtml);
            });
        }

        function initSortable() {
            $('#tabsList').sortable({
                items: '.sortable-item',
                handle: '.drag-handle',
                placeholder: 'sortable-placeholder',
                update: function () {
                    saveSortOrder();
                }
            });
        }

        function saveSortOrder() {
            const tabs = [];
            $('#tabsList .sortable-item').each(function () {
                tabs.push({
                    tabId: $(this).data('tab-id')
                });
            });

            $.ajax({
                url: '/CustomFieldTab/ReorderTabs',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    entityId: groupId,
                    tabs: tabs
                }),
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', 'Sắp xếp tab thành công');
                    } else {
                        showError('Lỗi', response.message);
                        loadTabs(); // Reload to restore original order
                    }
                },
                error: function () {
                    showError('Lỗi', 'Không thể sắp xếp tab');
                    loadTabs(); // Reload to restore original order
                }
            });
        }

        function openCreateTabModal() {
            currentEditingTabId = null;
            $('#tabId').val('');
            $('#tabName').val('');
            $('#tabModalTitle').html('<i class="ri-folder-add-line me-2"></i>Tạo Tab Mới');
            $('#tabModal').modal('show');
            $('#tabName').focus();
        }

        function openEditTabModal(tabId, tabName) {
            currentEditingTabId = tabId;
            $('#tabId').val(tabId);
            $('#tabName').val(tabName);
            $('#tabModalTitle').html('<i class="ri-edit-line me-2"></i>Chỉnh sửa Tab');
            $('#tabModal').modal('show');
            $('#tabName').focus();
        }

        function saveTab() {
            const tabName = $('#tabName').val().trim();

            if (!tabName) {
                showError('Lỗi', 'Tên tab không được để trống');
                return;
            }

            const isCreate = !currentEditingTabId;
            const url = isCreate ? '/CustomFieldTab/CreateTab' : '/CustomFieldTab/UpdateTab';
            const method = isCreate ? 'POST' : 'PUT';

            const data = {
                id: currentEditingTabId,
                tabName: tabName,
                entityType: 1, // GroupMembership
                entityId: groupId
            };

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message);
                        $('#tabModal').modal('hide');
                        loadTabs();
                    } else {
                        showError('Lỗi', response.message);
                    }
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi lưu tab');
                }
            });
        }

        function openDeleteConfirm(tabId, tabName) {
            currentDeletingTabId = tabId;
            $('#deleteTabName').text(tabName);
            $('#deleteConfirmModal').modal('show');
        }

        function confirmDeleteTab() {
            if (!currentDeletingTabId) return;

            $.ajax({
                url: `/CustomFieldTab/DeleteTab?tabId=${currentDeletingTabId}`,
                type: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message);
                        $('#deleteConfirmModal').modal('hide');
                        loadTabs();
                    } else {
                        showError('Lỗi', response.message);
                    }
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi xóa tab');
                }
            });
        }

        function manageFields(tabId, tabName) {
            window.location.href = `/CustomField/Index?tabId=${tabId}`;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
}
