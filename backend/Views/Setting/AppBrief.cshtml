@{
    ViewData["Title"] = "Brief Giới Thiệu App";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        background-color: #f8f9fa;
    }
    
    .upload-area:hover {
        border-color: #0d6efd;
        background-color: #e7f3ff;
    }
    
    .upload-area.dragover {
        border-color: #0d6efd;
        background-color: #e7f3ff;
        transform: scale(1.02);
    }

    .upload-area.has-file {
        border-color: #198754;
        background-color: #d1e7dd;
    }

    #quillEditor {
        min-height: 400px;
    }

    .ql-editor {
        min-height: 400px;
    }

    .pdf-preview {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .pdf-preview iframe {
        width: 100%;
        height: 600px;
        border: none;
        border-radius: 4px;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background-color: #e7f3ff;
        border-radius: 6px;
        margin-top: 15px;
    }

    .file-info i {
        font-size: 24px;
        color: #dc3545;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-3">Brief Giới Thiệu App</h4>
                <p class="mb-0 text-muted">Quản lý nội dung giới thiệu ứng dụng (Editor hoặc PDF Upload)</p>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" id="appBriefTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="html-tab" data-bs-toggle="tab" data-bs-target="#html-content" type="button" role="tab">
                            <i class="ri-file-edit-line me-2"></i>Soạn nội dung
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf-content" type="button" role="tab">
                            <i class="ri-file-pdf-line me-2"></i>Upload file PDF
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="appBriefTabContent">
                    <!-- HTML Editor Tab -->
                    <div class="tab-pane fade show active" id="html-content" role="tabpanel">
                        <div class="position-relative">
                            <div id="quillEditor"></div>
                            <div class="loading-overlay" id="htmlLoadingOverlay" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="resetHtmlEditor()">
                                <i class="ri-refresh-line me-2"></i>Làm mới
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveHtmlContent()">
                                <i class="ri-save-line me-2"></i>Lưu nội dung
                            </button>
                        </div>
                    </div>

                    <!-- PDF Upload Tab -->
                    <div class="tab-pane fade" id="pdf-content" role="tabpanel">
                        <div class="position-relative">
                            <!-- Upload Area -->
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('pdfFileInput').click()">
                                <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" />
                                <i class="ri-upload-cloud-2-line" style="font-size: 48px; color: #6c757d; margin-bottom: 15px;"></i>
                                <h5 class="mb-2">Kéo thả file PDF vào đây hoặc click để chọn</h5>
                                <p class="text-muted mb-0">Chỉ chấp nhận file PDF, tối đa 50MB</p>
                            </div>

                            <!-- File Info (khi chọn file mới) -->
                            <div id="fileInfo" class="file-info" style="display: none;">
                                <i class="ri-file-pdf-line"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold" id="fileName"></div>
                                    <small class="text-muted" id="fileSize"></small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePdfFile()">
                                        <i class="ri-delete-bin-line me-1"></i>Xóa
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="savePdfFile()" id="btnSavePdf">
                                        <i class="ri-save-line me-1"></i>Lưu
                                    </button>
                                </div>
                            </div>

                            <!-- Saved PDF Info (khi đã có file lưu) -->
                            <div id="savedPdfInfo" class="alert alert-success" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="ri-file-pdf-line me-2"></i>
                                        <strong>File PDF đã được lưu</strong>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewPdfPreview()">
                                            <i class="ri-eye-line me-1"></i>Xem tài liệu
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePdf()" id="btnDeletePdf">
                                            <i class="ri-delete-bin-line me-1"></i>Xóa file
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- PDF Preview (ẩn mặc định, chỉ hiển thị khi click "Xem tài liệu") -->
                            <div id="pdfPreview" class="pdf-preview mt-4" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Xem trước PDF</h6>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closePdfPreview()">
                                            <i class="ri-close-line me-1"></i>Đóng
                                        </button>
                                    </div>
                                </div>
                                <iframe id="pdfViewer" src=""></iframe>
                            </div>

                            <div class="loading-overlay" id="pdfLoadingOverlay" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quill Editor CSS & JS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let quill;
    let currentMode = 'html'; // 'html' or 'pdf'
    let currentPdfUrl = null;
    let currentTempPdfUrl = null; // Lưu temp file path khi upload
    let isPdfSaved = false; // Kiểm tra PDF đã được lưu vào DB chưa
    let currentSelectedFile = null; // File đã chọn nhưng chưa upload

    // Initialize Quill Editor
    document.addEventListener('DOMContentLoaded', function() {
        quill = new Quill('#quillEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'font': [] }],
                    [{ 'size': [] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'align': [] }],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            }
        });

        // Load existing content
        loadAppBrief();

        // Setup drag and drop for PDF
        setupDragAndDrop();
    });

    // Load App Brief content
    async function loadAppBrief() {
        try {
            const response = await fetch('/Setting/GetAppBrief');
            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;
                
                if (data.isPdf && data.pdfUrl) {
                    // Show PDF mode
                    currentMode = 'pdf';
                    currentPdfUrl = data.pdfUrl;
                    isPdfSaved = true; // PDF đã được lưu trong DB

                    // Switch to PDF tab
                    document.getElementById('pdf-tab').click();

                    // THAY ĐỔI: KHÔNG TỰ ĐỘNG HIỂN THỊ PREVIEW
                    // Chỉ hiển thị thông tin file, user phải click "Xem tài liệu" để xem preview
                    showPdfInfo(data.pdfUrl, data.pdfFileName);
                } else if (data.content) {
                    // Show HTML mode
                    currentMode = 'html';
                    quill.root.innerHTML = data.content;
                }
            }
        } catch (error) {
            console.error('Error loading App Brief:', error);
            showError('Có lỗi xảy ra khi tải nội dung');
        }
    }

    // Save HTML content
    async function saveHtmlContent() {
        const htmlContent = quill.root.innerHTML;
        
        if (!htmlContent || htmlContent.trim() === '<p><br></p>') {
            showWarning('Cảnh báo', 'Nội dung đang trống. Bạn có muốn lưu không?');
            return;
        }

        try {
            showLoading('htmlLoadingOverlay');
            
            const response = await fetch('/Setting/SaveAppBriefHtml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: htmlContent })
            });

            const result = await response.json();

            if (result.success) {
                showSuccess('Thành công', result.message || 'Lưu nội dung thành công');
                currentMode = 'html';
            } else {
                showError(result.message || 'Có lỗi xảy ra khi lưu nội dung');
            }
        } catch (error) {
            console.error('Error saving HTML:', error);
            showError('Có lỗi xảy ra khi lưu nội dung');
        } finally {
            hideLoading('htmlLoadingOverlay');
        }
    }

    // Reset HTML editor
    async function resetHtmlEditor() {
        let confirmed = false;
        
        if (typeof Swal !== 'undefined') {
            const result = await Swal.fire({
                icon: 'warning',
                title: 'Xác nhận làm mới',
                text: 'Bạn có chắc muốn làm mới nội dung? Tất cả thay đổi chưa lưu sẽ bị mất.',
                showCancelButton: true,
                confirmButtonText: 'Làm mới',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });
            confirmed = result.isConfirmed;
        } else {
            confirmed = confirm('Bạn có chắc muốn làm mới nội dung? Tất cả thay đổi chưa lưu sẽ bị mất.');
        }
        
        if (confirmed) {
            quill.root.innerHTML = '';
        }
    }

    // Setup drag and drop
    function setupDragAndDrop() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('dragover');
            }, false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }

    function handleFile(file) {
        // Validate file
        if (file.type !== 'application/pdf') {
            showError('Chỉ chấp nhận file PDF');
            return;
        }

        if (file.size > 50 * 1024 * 1024) {
            showError('File quá lớn. Kích thước tối đa là 50MB');
            return;
        }

        // THAY ĐỔI: Chỉ hiển thị thông tin file, KHÔNG UPLOAD NGAY
        // Lưu file để upload khi user bấm "Lưu"
        currentSelectedFile = file;

        // Show file info
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('fileInfo').style.display = 'flex';
        document.getElementById('uploadArea').classList.add('has-file');
    }

    // THAY ĐỔI: Upload và lưu file trong một lần, không có temp preview
    async function savePdfFile() {
        if (!currentSelectedFile) {
            showError('Vui lòng chọn file PDF để tải lên');
            return;
        }

        try {
            showLoading('pdfLoadingOverlay');

            const formData = new FormData();
            formData.append('file', currentSelectedFile);

            // Step 1: Upload to temp
            const uploadResponse = await fetch('/Setting/UploadAppBriefPdfTemp', {
                method: 'POST',
                body: formData
            });

            const uploadResult = await uploadResponse.json();

            if (!uploadResult.success) {
                showError(uploadResult.message || 'Có lỗi xảy ra khi tải lên file');
                return;
            }

            currentTempPdfUrl = uploadResult.data.pdfUrl;

            // Step 2: Save to DB immediately
            const saveResponse = await fetch('/Setting/SaveAppBriefPdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tempFilePath: currentTempPdfUrl })
            });

            const saveResult = await saveResponse.json();

            if (saveResult.success) {
                showSuccess('Thành công', saveResult.message || 'Lưu file PDF thành công');
                currentPdfUrl = saveResult.data.pdfUrl;
                currentTempPdfUrl = null;
                currentSelectedFile = null;
                isPdfSaved = true;
                currentMode = 'pdf';

                // THAY ĐỔI: Không tự động hiển thị preview, chỉ hiển thị thông tin file
                showPdfInfo(saveResult.data.pdfUrl, saveResult.data.pdfFileName);

                // Reset upload area
                removePdfFile();
            } else {
                showError(saveResult.message || 'Có lỗi xảy ra khi lưu file');
            }
        } catch (error) {
            console.error('Error saving PDF:', error);
            showError('Có lỗi xảy ra khi lưu file');
        } finally {
            hideLoading('pdfLoadingOverlay');
        }
    }

    // THAY ĐỔI: Hàm mới để hiển thị thông tin file mà KHÔNG hiển thị preview
    function showPdfInfo(url, fileName) {
        // Ẩn upload area và file info
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('fileInfo').style.display = 'none';

        // Hiển thị thông tin file đã lưu
        document.getElementById('savedPdfInfo').style.display = 'block';

        // Ẩn preview mặc định
        document.getElementById('pdfPreview').style.display = 'none';
    }

    // Hàm hiển thị preview khi user click "Xem tài liệu"
    function viewPdfPreview() {
        if (currentPdfUrl) {
            document.getElementById('pdfViewer').src = currentPdfUrl;
            document.getElementById('pdfPreview').style.display = 'block';

            // Scroll to preview
            document.getElementById('pdfPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Hàm đóng preview
    function closePdfPreview() {
        document.getElementById('pdfPreview').style.display = 'none';
    }

    function removePdfFile() {
        if (!isPdfSaved && currentTempPdfUrl) {
            // Nếu là file temp chưa lưu, có thể xóa file temp (optional)
            // Hoặc chỉ reset UI
        }

        document.getElementById('pdfFileInput').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('pdfPreview').style.display = 'none';
        document.getElementById('savedPdfInfo').style.display = 'none'; // THÊM: Ẩn saved info
        document.getElementById('uploadArea').classList.remove('has-file');
        document.getElementById('uploadArea').style.display = 'block';
        currentTempPdfUrl = null;
        currentSelectedFile = null;
        isPdfSaved = false;
    }

    async function deletePdf() {
        // Sử dụng SweetAlert thay vì confirm()
        if (typeof Swal !== 'undefined') {
            const result = await Swal.fire({
                icon: 'warning',
                title: 'Xác nhận xóa',
                text: 'Bạn có chắc muốn xóa file PDF này?',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (!result.isConfirmed) {
                return;
            }
        } else {
            // Fallback nếu không có SweetAlert
            if (!confirm('Bạn có chắc muốn xóa file PDF này?')) {
                return;
            }
        }

        try {
            showLoading('pdfLoadingOverlay');

            const response = await fetch('/Setting/DeleteAppBriefPdf', {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showSuccess('Thành công', result.message || 'Đã xóa file PDF thành công');
                currentPdfUrl = null;
                currentTempPdfUrl = null;
                currentMode = 'html';
                isPdfSaved = false;
                
                // Reset PDF tab
                document.getElementById('pdfViewer').src = '';
                document.getElementById('pdfPreview').style.display = 'none';
                removePdfFile();
                
                // Switch to HTML tab
                document.getElementById('html-tab').click();
            } else {
                showError(result.message || 'Có lỗi xảy ra khi xóa file');
            }
        } catch (error) {
            console.error('Error deleting PDF:', error);
            showError('Có lỗi xảy ra khi xóa file');
        } finally {
            hideLoading('pdfLoadingOverlay');
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showLoading(overlayId) {
        document.getElementById(overlayId).style.display = 'flex';
    }

    function hideLoading(overlayId) {
        document.getElementById(overlayId).style.display = 'none';
    }

    function showSuccess(title, message) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: title,
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            alert(message);
        }
    }

    function showError(message) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: message
            });
        } else {
            alert('Lỗi: ' + message);
        }
    }

    function showWarning(title, message) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'warning',
                title: title,
                text: message,
                showCancelButton: true,
                confirmButtonText: 'Có',
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveHtmlContent();
                }
            });
        } else {
            if (confirm(message)) {
                saveHtmlContent();
            }
        }
    }
</script>

