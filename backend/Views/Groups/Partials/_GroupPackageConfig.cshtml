@{
    ViewData["Title"] = null; // partial does not set page title
}

<style>
    .custom-dropdown { position: relative; display: inline-block; width: 100%; }
    .custom-dropdown-toggle { cursor: pointer; display: flex; align-items: center; }
    .custom-dropdown-toggle:hover { border-color: #86b7fe; }
    .custom-dropdown-toggle:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
    .custom-dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; display: none; max-height: 200px; overflow-y: auto; background-color: #fff; border: 1px solid #ced4da; border-radius: 0.375rem; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); margin-top: 2px; }
    .custom-dropdown-menu.show { display: block; }
    .custom-dropdown-item { display: block; width: 100%; padding: 0.5rem 0.75rem; color: #212529; text-decoration: none; white-space: nowrap; background-color: transparent; border: 0; cursor: pointer; border-bottom: 1px solid #f8f9fa; }
    .custom-dropdown-item:last-child { border-bottom: none; }
    .custom-dropdown-item:hover { color: #1e2125; background-color: #e9ecef; }
    .custom-dropdown-item.selected { background-color: #0d6efd; color: #fff; }
    .custom-dropdown-item input[type="checkbox"] { margin-right: 0.5rem; }
    .selected-items { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem; }
    .selected-item { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; font-size: 0.875rem; background-color: #e7f1ff; border: 1px solid #b3d7ff; border-radius: 0.25rem; color: #0c63e4; }
    .selected-item .remove { margin-left: 0.25rem; cursor: pointer; color: #6c757d; }
    .selected-item .remove:hover { color: #dc3545; }
</style>

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
                <div>
                    <h4 class="mb-3">
                        Gán Gói Cước Cho Hội Nhóm
                    </h4>
                    <p class="mb-0 text-muted">Quản lý gán các gói cước vào hội nhóm</p>
                </div>

                <div class="d-flex align-items-center justify-content-between">
                    <button type="button" class="btn btn-primary shadow-sm" onclick="openAssignCreateModal()">
                        <i class="ri-add-line me-2"></i>
                        Gán Gói Mới
                    </button>
                </div>
            </div>
        </div>

        <!-- Bộ lọc -->
        <div class="col-lg-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 d-flex align-items-center">
                        <i class="ri-filter-3-line me-2"></i>
                        Bộ lọc tìm kiếm
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Thanh tìm kiếm -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Tìm kiếm</label>
                                <div class="input-group">
                                    <input id="searchInput" type="text" class="form-control" placeholder="Tìm theo tên nhóm, tên gói..." />
                                    <button class="btn btn-primary" onclick="loadAssignData()">
                                        <i class="ri-search-line"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Nút lọc -->
                        <div class="col-md-6">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light border flex-fill" onclick="resetAssignFilters()">
                                    <i class="ri-refresh-line me-1"></i>
                                    Đặt lại
                                </button>
                                <button class="btn btn-primary flex-fill" onclick="loadAssignData()">
                                    <i class="ri-filter-line me-1"></i>
                                    Lọc dữ liệu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bảng dữ liệu -->
    <div class="col-lg-12">
        <div class="row mt-2 justify-content-between dt-layout-table">
            <div class="d-md-flex justify-content-between align-items-center col-12 dt-layout-full col-md">
                <table class="data-table table mb-0 tbl-server-info dataTable" id="configsTable">
                    <thead class="ligth ligth-data">
                        <tr>
                            <th width="5%" class="text-center">#</th>
                            <th width="25%">Hội Nhóm</th>
                            <th width="25%">Gói Cước</th>
                            <th width="15%" class="text-center">Trạng Thái</th>
                            <th width="15%" class="text-center">Ngày Tạo</th>
                            <th width="15%" class="text-center">Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody id="configsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="dataTables_info" id="tableInfo">Hiển thị 0 đến 0 của 0 dòng</div>
            </div>
            <div class="col-md-6">
                <div class="dataTables_paginate paging_simple_numbers" id="pagination"></div>
            </div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="ri-add-line me-2"></i>
                    Gán Gói Cước Cho Hội Nhóm
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Hội Nhóm <span class="text-danger">*</span></label>
                            <select class="form-select" id="groupId" required>
                                <option value="">-- Chọn hội nhóm --</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Gói Cước <span class="text-danger">*</span></label>
                            <div class="custom-dropdown">
                                <div class="form-select custom-dropdown-toggle" id="subscriptionPlanToggle">
                                    <span id="subscriptionPlanText">-- Chọn gói cước --</span>
                                </div>
                                <div class="custom-dropdown-menu" id="subscriptionPlanMenu"></div>
                                <div class="selected-items" id="selectedPlans"></div>
                            </div>
                            <input type="hidden" id="subscriptionPlanId" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="isActive">
                                <option value="true" selected>Hoạt động</option>
                                <option value="false">Không hoạt động</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAssignCreate()">
                    <i class="ri-save-line me-1"></i>
                    Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="ri-edit-line me-2"></i>
                    Chỉnh Sửa Gán Gói Cước
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editConfigId" />
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Hội Nhóm <span class="text-danger">*</span></label>
                            <select class="form-select" id="editGroupId" required>
                                <option value="">-- Chọn hội nhóm --</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Gói Cước <span class="text-danger">*</span></label>
                            <div class="custom-dropdown">
                                <div class="form-select custom-dropdown-toggle" id="editSubscriptionPlanToggle">
                                    <span id="editSubscriptionPlanText">-- Chọn gói cước --</span>
                                </div>
                                <div class="custom-dropdown-menu" id="editSubscriptionPlanMenu"></div>
                                <div class="selected-items" id="editSelectedPlans"></div>
                            </div>
                            <input type="hidden" id="editSubscriptionPlanId" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="editIsActive">
                                <option value="true" selected>Hoạt động</option>
                                <option value="false">Không hoạt động</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAssignEdit()">
                    <i class="ri-save-line me-1"></i>
                    Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Delete Confirm Modal -->
<div class="modal fade" id="assignDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa cấu hình này không?</p>
                <p class="text-muted small">Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmAssignDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>