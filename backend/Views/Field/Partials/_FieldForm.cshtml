@model MiniAppGIBA.Models.Request.Fields.CreateFieldRequest

<div class="modal-content border-0 shadow-lg">
    <!-- Header -->
    <div class="modal-header border-0 bg-primary text-white">
        <h5 class="modal-title fw-bold">
            <i class="@(ViewBag.IsEdit ? "ri-edit-line" : "ri-add-line") me-2"></i>
            @(ViewBag.IsEdit ? "Chỉnh sửa lĩnh vực" : "Thêm lĩnh vực mới")
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <!-- Body -->
    <div class="modal-body p-4">
        <form id="fieldForm" onsubmit="submitFieldForm(event)">
            @Html.AntiForgeryToken()
            @if (ViewBag.IsEdit)
            {
                <input type="hidden" name="Id" value="@ViewBag.FieldId" />
            }

            <div class="row g-4">
                <!-- Field Name -->
                <div class="col-md-8">
                    <label asp-for="FieldName" class="form-label fw-medium">
                        Tên danh mục <span class="text-danger">*</span>
                    </label>
                    <input asp-for="FieldName" name="FieldName" class="form-control" placeholder="Nhập tên danh mục"
                        required />
                    <span asp-validation-for="FieldName" class="text-danger small"></span>
                </div>

                <!-- Display Order -->
                <div class="col-md-4">
                    <label class="form-label fw-medium">Thứ tự hiển thị</label>
                    <input type="number" name="DisplayOrderMiniApp" class="form-control" placeholder="0" min="0" />
                    <small class="text-muted">Thứ tự hiển thị trong MiniApp</small>
                </div>

                <!-- Description -->
                <div class="col-12">
                    <label class="form-label fw-medium">Mô tả</label>
                    <textarea name="Description" class="form-control" rows="2" placeholder="Mô tả về danh mục (tùy chọn)"></textarea>
                </div>

                <!-- Status -->
                <div class="col-12">
                    <label class="form-label fw-medium">Trạng thái hoạt động</label>
                    <select class="form-select" id="IsActive" name="IsActive">
                        <option value="true">Hoạt động</option>
                        <option value="false">Không hoạt động</option>
                    </select>
                </div>

                <!-- Field Children Section -->
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label fw-medium mb-0">Danh mục con</label>
                        <button type="button" class="btn btn-sm btn-success" onclick="addFieldChild()">
                            <i class="ri-add-line me-1"></i>
                            Thêm danh mục con
                        </button>
                    </div>
                    
                    <div id="childrenContainer" class="border rounded p-3 bg-light">
                        <div id="emptyChildrenMessage" class="text-center text-muted py-3">
                            <i class="ri-folder-open-line display-6 mb-2"></i>
                            <p class="mb-0">Chưa có danh mục con nào</p>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="ri-close-line me-1"></i>
            Hủy
        </button>
        <button type="submit" form="fieldForm" class="btn btn-primary">
            <i class="ri-save-line me-1"></i>
            @(ViewBag.IsEdit ? "Cập nhật" : "Thêm mới")
        </button>
    </div>
</div>

<script>
    let childrenCount = 0;
    let fieldChildren = [];

    function resetFormState() {
        // Clear existing children
        $('.child-item').remove();
        childrenCount = 0;
        fieldChildren = [];
        updateEmptyMessage();
    }

    // Function to initialize form - call this when modal opens
    function initFieldForm() {
        const isEdit = @(ViewBag.IsEdit ? "true" : "false");
        
     
        resetFormState();
        
        // Clear all form fields regardless of mode to ensure fresh start
        $('input[name="FieldName"]').val('');
        $('input[name="DisplayOrderMiniApp"]').val('0');
        $('textarea[name="Description"]').val('');
        $('select[name="IsActive"]').val('true');
        
        // Then load fresh data for edit mode
        if (isEdit) {
            loadFieldData();
        } else {
            // For create mode, just ensure empty message is shown
            updateEmptyMessage();
        }
    }

    // Initialize form when DOM ready (will be called from openFieldModal)
    $(document).ready(function() {
        // Don't call initFieldForm here as it will be called from openFieldModal
        // Just ensure empty message is shown for create mode
        const isEdit = @(ViewBag.IsEdit ? "true" : "false");
        if (!isEdit) {
            updateEmptyMessage();
        }
    });

    function loadFieldData() {
        const isEdit = @(ViewBag.IsEdit ? "true" : "false");
        
        if (isEdit) {
            // Always get fresh data from API instead of using ViewBag
            const fieldId = $('input[name="Id"]').val();
            if (fieldId) {
                loadFieldDataFromAPI(fieldId);
            }
        }
        updateEmptyMessage();
    }

    function loadFieldDataFromAPI(fieldId) {
        // Get fresh field data from API
        $.ajax({
            url: '/Field/GetFieldDetails',
            type: 'GET',
            cache: false,
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            data: { 
                id: fieldId,
                _t: new Date().getTime() // Cache busting
            },
            success: function(response) {
                if (response.success && response.data) {
                    const data = response.data;
                    
                    // Fill form with fresh data from API
                    $('input[name="FieldName"]').val(data.fieldName || '');
                    $('textarea[name="Description"]').val(data.description || '');
                    $('input[name="DisplayOrderMiniApp"]').val(data.displayOrderMiniApp || 0);
                    $('select[name="IsActive"]').val(data.isActive ? 'true' : 'false');
                    
                    console.log('Edit mode - filled form with fresh API data:');
                    console.log('FieldName:', data.fieldName);
                    console.log('Description:', data.description);
                    console.log('DisplayOrderMiniApp:', data.displayOrderMiniApp);
                    console.log('IsActive:', data.isActive);
                    
                    // Load children data
                    loadChildrenFromAPIData(data.children || []);
                } else {
                    console.error('Failed to load field data:', response.message);
                    showError('Lỗi', 'Không thể tải dữ liệu danh mục');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading field data:', error);
                showError('Lỗi', 'Có lỗi xảy ra khi tải dữ liệu danh mục');
            }
        });
    }

    function loadChildrenFromAPIData(children) {
        // Clear existing children first
        $('.child-item').remove();
        childrenCount = 0;
        
        // Add each child
        if (children && children.length > 0) {
            console.log('Loading', children.length, 'children from API');
            children.forEach(function(child) {
                addFieldChild(child);
            });
        } else {
            console.log('No children found');
        }
        updateEmptyMessage();
    }


    function addFieldChild(existingData = null) {
        childrenCount++;
        const childId = existingData ? existingData.id || '' : '';
        const childName = existingData ? existingData.childName || '' : '';
        const description = existingData ? existingData.description || '' : '';

        const childHtml = `
            <div class="child-item border rounded p-2 mb-2 bg-white position-relative" data-child-index="${childrenCount}">
                <button type="button" class="btn btn-sm btn-danger position-absolute" 
                        style="top: 6px; right: 6px; width: 20px; height: 20px; padding: 0; font-size: 10px;"
                        onclick="removeFieldChild(${childrenCount})" title="Xóa danh mục con">
                    <i class="ri-close-line"></i>
                </button>
                
                <div class="row g-2" style="padding-right: 30px;">
                    <input type="hidden" name="Children[${childrenCount-1}].Id" value="${childId}" />
                    
                    <div class="col-8">
                        <label class="form-label small mb-1">Tên danh mục con <span class="text-danger">*</span></label>
                        <input type="text" name="Children[${childrenCount-1}].ChildName" class="form-control form-control-sm" 
                               placeholder="nhập tên..." value="${childName}" required />
                    </div>
                    
                    <div class="col-4">
                        <label class="form-label small mb-1">Mô tả</label>
                        <input type="text" name="Children[${childrenCount-1}].Description" class="form-control form-control-sm" 
                               placeholder="nhập mô tả..." value="${description}" />
                    </div>
                </div>
            </div>
        `;

        $('#emptyChildrenMessage').hide();
        $('#childrenContainer').append(childHtml);
        updateEmptyMessage();
    }

    function removeFieldChild(childIndex) {
        $(`.child-item[data-child-index="${childIndex}"]`).remove();
        updateEmptyMessage();
        reindexChildren();
    }

    function updateEmptyMessage() {
        const hasChildren = $('.child-item').length > 0;
        if (hasChildren) {
            $('#emptyChildrenMessage').hide();
        } else {
            $('#emptyChildrenMessage').show();
        }
    }

    function reindexChildren() {
        $('.child-item').each(function(index) {
            const $item = $(this);
            
            // Update all input names with new index
            $item.find('input, select').each(function() {
                const $input = $(this);
                let name = $input.attr('name');
                if (name && name.includes('Children[')) {
                    name = name.replace(/Children\[\d+\]/, `Children[${index}]`);
                    $input.attr('name', name);
                }
            });
            
            // Update title
            $item.find('h6').html(`<i class="ri-folder-line me-1"></i>Danh mục con #${index + 1}`);
        });
    }

    function submitFieldForm(event) {
        event.preventDefault();

        const isEdit = @(ViewBag.IsEdit ? "true" : "false");

        const fieldName = document.querySelector('input[name="FieldName"]').value.trim();
        const description = document.querySelector('textarea[name="Description"]').value.trim();
        const displayOrderMiniApp = parseInt(document.querySelector('input[name="DisplayOrderMiniApp"]').value) || 0;
        const isActive = document.querySelector('select[name="IsActive"]').value === 'true';

        // Validation
        if (!fieldName) {
            showWarning('Cảnh báo', 'Vui lòng nhập tên danh mục');
            return;
        }

        // Validate children
        const childInputs = document.querySelectorAll('input[name*="Children"][name*="ChildName"]');
        for (let input of childInputs) {
            if (!input.value.trim()) {
                showWarning('Cảnh báo', 'Vui lòng nhập tên cho tất cả danh mục con hoặc xóa các danh mục con trống');
                input.focus();
                return;
            }
        }

        // Prepare request data
        const requestData = {
            FieldName: fieldName,
            Description: description,
            DisplayOrderMiniApp: displayOrderMiniApp,
            IsActive: isActive,
            Children: []
        };

        // Add Id for edit
        if (isEdit) {
            requestData.Id = document.querySelector('input[name="Id"]').value;
        }

        // Collect children data
        $('.child-item').each(function(index) {
            const $item = $(this);
            const childData = {
                ChildName: $item.find(`input[name="Children[${index}].ChildName"]`).val().trim(),
                Description: $item.find(`input[name="Children[${index}].Description"]`).val().trim()
            };
            
            // Add Id if editing existing child
            const childId = $item.find(`input[name="Children[${index}].Id"]`).val();
            if (childId) {
                childData.Id = childId;
            }
            
            // For UpdateFieldRequest, add IsDeleted property
            if (isEdit) {
                childData.IsDeleted = false;
            }
            
            requestData.Children.push(childData);
        });

        // Determine URL
        const url = isEdit ? '/Field/Edit' : '/Field/Create';

        // Submit form
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    showSuccess('Thành công', response.message);
                    $('#fieldModal').modal('hide');

                    // Reload DataTable
                    if (typeof fieldsTable !== 'undefined') {
                        fieldsTable.ajax.reload();
                    }
                } else {
                    showError('Lỗi', response.message);
                }
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                showError('Lỗi', response?.message || 'Có lỗi xảy ra khi lưu danh mục');
            }
        });
    }
</script>
