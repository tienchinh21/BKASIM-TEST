@{

    ViewData["Title"] = "Quản Lý Hạng Nhà Tài Trợ";

    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Http
@using MiniAppGIBA.Constants;
@inject IHttpContextAccessor HttpContextAccessor
@{

    var canEdit = User?.IsInRole(CTRole.GIBA) == true;
}

<style>
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
    }

    /* Delete Modal Styles */
    #deleteConfirmModal .modal-dialog {
        animation: modalSlideIn 0.3s ease-out;
    }

    @@keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    #deleteConfirmModal .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #fef9e7 100%);
        border-left: 4px solid #ffc107;
    }

    #deleteConfirmModal .btn-danger:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        transition: all 0.2s ease;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-3">Quản Lý Hạng Nhà Tài Trợ</h4>
                <p class="mb-0 text-muted">Quản lý danh sách hạng nhà tài trợ trong hệ thống</p>
            </div>

            <div class="d-flex align-items-center justify-content-between">
                @if (canEdit)

                {
                    <a class="btn btn-primary shadow-sm" href="#" onclick="openCreateModal(); return false;">
                        <i class="ri-add-line me-2"></i>
                        Tạo Hạng Tài Trợ
                    </a>

                }
            </div>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="ri-filter-3-line me-2"></i>
                    Bộ lọc tìm kiếm
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Thanh tìm kiếm -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Tìm kiếm</label>
                            <div class="input-group">
                                <input id="search" type="text" class="form-control"
                                    placeholder="Tìm theo tên hạng tài trợ..." />
                                <button class="btn btn-primary" onclick="sponsorshipTiersTable.ajax.reload()">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bộ lọc trạng thái -->
                    <div class="col-md-3">
                        <label class="form-label">Trạng thái</label>
                        <select id="filter-status" class="form-select" onchange="sponsorshipTiersTable.ajax.reload()">
                            <option value="">Tất cả trạng thái</option>
                            <option value="true">Đang hoạt động</option>
                            <option value="false">Ngưng hoạt động</option>
                        </select>
                    </div>

                    <!-- Nút đặt lại -->
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light border flex-fill" onclick="resetFilters()">
                                <i class="ri-refresh-line me-1"></i>
                                Đặt lại
                            </button>
                            <button class="btn btn-primary flex-fill" onclick="sponsorshipTiersTable.ajax.reload()">
                                <i class="ri-filter-line me-1"></i>
                                Lọc
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bảng dữ liệu -->
    <div class="col-lg-12">
        <div class="table-responsive rounded mb-3">
            <table id="list-sponsorship-tiers" class="data-table table mb-0 tbl-server-info"></table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <!-- Header -->
            <div class="modal-header border-0 bg-danger text-white">
                <h5 class="modal-title fw-bold">
                    <i class="ri-delete-bin-line me-2"></i>
                    Xác nhận xóa hạng nhà tài trợ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-4 text-center">
                <div class="mb-4">
                    <div class="text-danger mb-3">
                        <i class="ri-alert-line display-4"></i>
                    </div>
                    <h6 class="mb-3">Bạn có chắc chắn muốn xóa hạng nhà tài trợ này?</h6>
                    <div class="alert alert-warning border-0">
                        <div class="d-flex align-items-start">
                            <i class="ri-information-line text-warning me-2 mt-1"></i>
                            <div class="text-start">
                                <div class="fw-bold mb-1">Hạng nhà tài trợ sẽ bị xóa:</div>
                                <div id="deleteItemName" class="text-primary fw-medium mb-2"></div>
                                <small class="text-muted">
                                    <i class="ri-error-warning-line me-1"></i>
                                    <strong>Lưu ý:</strong> Hành động này không thể hoàn tác và sẽ xóa vĩnh viễn tất cả
                                    dữ liệu liên quan.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy bỏ
                </button>
                <button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">
                    <i class="ri-delete-bin-line me-1"></i>
                    Xóa hạng nhà tài trợ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SponsorshipTier Modal -->
<div class="modal fade" id="sponsorshipTierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="ri-vip-crown-line me-2"></i>
                    Quản Lý Hạng Nhà Tài Trợ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
<script>
    var sponsorshipTiersTable;
    let searchTimeout; // Declare timeout variable outside function

    $(document).ready(function () {
        GetListSponsorshipTiers();
        $('#search').on('input', handleSearchInput);
    });

    function GetListSponsorshipTiers() {
        sponsorshipTiersTable = new DataTable("#list-sponsorship-tiers", {
            searching: false,
            sort: false,
            responsive: true,
            pageLength: 10,
            serverSide: true,
            ajax: function (data, callback, settings) {
                const page = (data.start / data.length) + 1;
                let keyword = $("#search").val();
                const isActive = $("#filter-status").val();

                $.ajax({
                    url: '/SponsorshipTier/GetPage',
                    type: 'GET',
                    data: {
                        page: page,
                        pageSize: data.length,
                        keyword: keyword,
                        isActive: isActive
                    },
                    success: function (response) {
                        console.log('API Response:', response);
                        const formattedData = response.data.map((item, index) => ({
                            index: data.start + index + 1,
                            tierInfo: `<div class="d-flex align-items-center">
                                                        ${item.image ?
                                    `<img src="${item.image}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;" />` :
                                    `<div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="ri-vip-crown-line text-white"></i></div>`
                                }
                                                        <div>
                                                            <h6 class="mb-1">${item.tierName}</h6>
                                                        </div>
                                                    </div>`,
                            description: item.description ?
                                `<div class="text-truncate" style="max-width: 200px;" title="${item.description}">${item.description}</div>` :
                                '<span class="text-muted">Không có</span>',
                            isActive: item.isActive
                                ? '<span class="badge bg-success">Hoạt động</span>'
                                : '<span class="badge bg-secondary">Không hoạt động</span>',
                            createdDate: new Date(item.createdDate).toLocaleDateString('vi-VN'),
                            actions: `<div class="d-flex align-items-center justify-content-center gap-1">
                                                    <button onclick="openEditModal('${item.id}')"
                                                            class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                                        <i class="ri-edit-line"></i>
                                                    </button>
                                                    <button onclick="confirmDelete('${item.id}', '${item.tierName}')"
                                                            class="btn btn-sm btn-outline-danger" title="Xóa">
                                                        <i class="ri-delete-bin-line"></i>
                                                    </button>
                                                </div>`
                        }));

                        console.log('Formatted Data:', formattedData);
                        callback({
                            draw: data.draw,
                            recordsTotal: response.recordsTotal,
                            recordsFiltered: response.recordsFiltered,
                            data: formattedData
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading data:', error);
                        console.error('Response:', xhr.responseText);
                        callback({
                            draw: data.draw,
                            recordsTotal: 0,
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                });
            },
            columns: [
                { title: "STT", data: "index", className: 'text-center', width: "60px" },
                { title: "Thông Tin", data: "tierInfo", className: 'col-4' },
                { title: "Mô Tả", data: "description", className: 'col-3' },
                { title: "Trạng Thái", data: "isActive", className: 'text-center', width: "120px" },
                { title: "Ngày Tạo", data: "createdDate", className: 'text-center', width: "120px" },
                { title: "Thao Tác", data: "actions", className: 'text-center', width: "120px" }
            ],
            language: {
                "lengthMenu": "Hiển thị _MENU_ dòng mỗi trang",
                "zeroRecords": "Không tìm thấy kết quả",
                "info": "Hiển thị từ _START_ đến _END_ của _TOTAL_ dòng",
                "infoEmpty": "Không có dữ liệu",
                "infoFiltered": "(lọc từ tổng số _MAX_ dòng)"
            }
        });

        $(sponsorshipTiersTable.table().header()).addClass('ligth ligth-data');
    }

    function handleSearchInput() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            sponsorshipTiersTable.ajax.reload();
        }, 500);
    }

    function resetFilters() {
        $('#search').val('');
        $('#filter-status').val('');
        sponsorshipTiersTable.ajax.reload();
    }

    let deleteItemData = null; // Store delete item data temporarily

    function confirmDelete(id, name) {
        // Store delete data for later use
        deleteItemData = { id: id, name: name };

        // Set the item name in modal
        $('#deleteItemName').text(`"${name}"`);

        // Show the modal
        $('#deleteConfirmModal').modal('show');
    }

    // Handle delete confirmation
    $(document).on('click', '#confirmDeleteBtn', function () {
        if (!deleteItemData) return;

        const { id, name } = deleteItemData;

        // Disable button and show loading
        const $btn = $(this);
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Đang xóa...');

        $.ajax({
            url: '/SponsorshipTier/Delete',
            type: 'POST',
            data: {
                id: id,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                $('#deleteConfirmModal').modal('hide');

                if (response.success) {
                    showSuccess('Thành công', response.message || 'Xóa hạng nhà tài trợ thành công');
                    sponsorshipTiersTable.ajax.reload(null, false);
                } else {
                    showError('Lỗi', response.message || 'Có lỗi xảy ra');
                }
            },
            error: function (xhr) {
                $('#deleteConfirmModal').modal('hide');
                const errorMessage = xhr.responseJSON?.message || 'Có lỗi xảy ra khi xóa hạng nhà tài trợ';
                showError('Lỗi', errorMessage);
            },
            complete: function () {
                // Reset button state
                $btn.prop('disabled', false).html(originalText);
                deleteItemData = null;
            }
        });
    });

    // Clean up delete modal data when closed
    $(document).on('hidden.bs.modal', '#deleteConfirmModal', function () {
        deleteItemData = null;
        $('#deleteItemName').text('');
        // Reset button state in case it was left in loading state
        $('#confirmDeleteBtn').prop('disabled', false).html('<i class="ri-delete-bin-line me-1"></i>Xóa hạng nhà tài trợ');
    });

    function openCreateModal() {
        try {
            $.get('/SponsorshipTier/Create', function (data) {
                $('#sponsorshipTierModal .modal-body').html(data);
                $('#sponsorshipTierModal').modal('show');
            }).fail(function (xhr, status, error) {
                console.error('Error loading create form:', error);
                console.error('Response:', xhr.responseText);
                showError('Lỗi', 'Không thể tải form tạo hạng nhà tài trợ');
            });
        } catch (e) {
            console.error('Error in openCreateModal:', e);
            showError('Lỗi', 'Có lỗi xảy ra');
        }
    }

    function openEditModal(sponsorshipTierId) {
        try {
            console.log('openEditModal called with sponsorshipTierId:', sponsorshipTierId);

            $.get(`/SponsorshipTier/Edit/${sponsorshipTierId}`, function (data) {
                console.log('Edit form loaded successfully');

                $('#sponsorshipTierModal .modal-body').html(data);
                $('#sponsorshipTierModal').modal('show');

                console.log('Modal shown with edit form');
            }).fail(function (xhr, status, error) {
                console.error('Error loading edit form:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                showError('Lỗi', 'Không thể tải form chỉnh sửa hạng nhà tài trợ');
            });
        } catch (e) {
            console.error('Error in openEditModal:', e);
            showError('Lỗi', 'Có lỗi xảy ra');
        }
    }

    function submitSponsorshipTierForm(isEdit, sponsorshipTierId) {
        const $submitBtn = $('#sponsorshipTierModal .btn-primary');
        const originalText = $submitBtn.html();
        $submitBtn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Đang lưu...');

        const formData = new FormData();


        formData.append('TierName', $('#tierName').val() || '');
        formData.append('Description', $('#description').val() || '');
        formData.append('IsActive', $('#isActive').val() === 'true');


        if (isEdit && sponsorshipTierId) {
            formData.append('Id', sponsorshipTierId);
            console.log('Edit mode - SponsorshipTierId:', sponsorshipTierId);
        }

        const shouldRemoveImage = $('#shouldRemoveImage').val() === 'true';
        if (shouldRemoveImage) {
            formData.append('ShouldRemoveImage', 'true');
            console.log('Should remove existing image');
        }

        const imageFile = $('#image')[0].files[0];
        if (imageFile) {
            formData.append('Image', imageFile);
            console.log('New image file:', imageFile.name); // Debug log
        }

        formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

        const url = isEdit ? '/SponsorshipTier/Edit' : '/SponsorshipTier/Create';
        console.log('Submitting to:', url, 'IsEdit:', isEdit); // Debug log

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                console.log('Response:', response);

                if (response.success) {
                    showSuccess('Thành công', response.message);
                    $('#sponsorshipTierModal').modal('hide');
                    sponsorshipTiersTable.ajax.reload();
                } else {
                    showError('Lỗi', response.message || 'Có lỗi xảy ra khi lưu');
                }
            },
            error: function (xhr, status, error) {
                console.error('Ajax error:', xhr.responseText);
                const errorMessage = xhr.responseJSON?.message || 'Có lỗi xảy ra khi lưu hạng nhà tài trợ';
                showError('Lỗi', errorMessage);
            },
            complete: function () {
                $submitBtn.prop('disabled', false).html(originalText);
            }
        });
    }
</script>
}
