@{
    ViewData["Title"] = "Lịch hẹn 1-1";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Style cho dropdown filter - giới hạn chiều cao và cho phép scroll */
    .form-control[size] {
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: calc(1.5rem * 5 + 0.75rem * 2);
        overflow-y: auto;
        overflow-x: hidden;
    }

    .form-control::-webkit-scrollbar {
        width: 6px;
    }

    .form-control::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .form-control::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .form-control::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-3">Lịch hẹn 1-1</h4>
                <p class="mb-0 text-muted">Xem thông tin lịch hẹn một-một. Chỉ đọc, không chỉnh sửa.</p>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="ri-filter-3-line me-2"></i>
                    Bộ lọc đơn giản
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Tìm kiếm theo tên</label>
                        <div class="input-group">
                            <input id="search" type="text" class="form-control" placeholder="Nhập tên lịch hẹn..." />
                            <button class="btn btn-primary" onclick="appointmentsTable.ajax.reload()">
                                <i class="ri-search-line"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Trạng thái</label>
                        <select id="filter-status" class="form-control" onchange="appointmentsTable.ajax.reload()">
                            <option value="">Tất cả</option>
                            <option value="1">Đã gửi</option>
                            <option value="2">Đã xác nhận</option>
                            <option value="3">Đã hủy</option>
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-end">
                        <div class="d-flex gap-2 w-100">
                            <button class="btn btn-light border flex-fill" onclick="resetFilters()">
                                <i class="ri-refresh-line me-1"></i>
                                Đặt lại
                            </button>
                            <button class="btn btn-primary flex-fill" onclick="appointmentsTable.ajax.reload()">
                                <i class="ri-filter-line me-1"></i>
                                Lọc dữ liệu
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <table id="list-appointments" class="table table-striped" style="width:100%">
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal xem chi tiết -->
<div class="modal fade" id="appointmentDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết lịch hẹn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Tên lịch hẹn</label>
                        <div id="detail-name" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nhóm</label>
                        <div id="detail-groupName" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Trạng thái</label>
                        <div id="detail-status" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Từ (Người gửi)</label>
                        <div id="detail-fromName" class="form-control bg-light d-flex align-items-center gap-2" style="min-height: 50px;">
                            <img id="detail-fromAvatar" src="" alt="Avatar" class="rounded-circle d-none" style="width: 40px; height: 40px; object-fit: cover;" onerror="this.style.display='none'">
                            <span id="detail-fromNameText"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tới (Người nhận)</label>
                        <div id="detail-toName" class="form-control bg-light d-flex align-items-center gap-2" style="min-height: 50px;">
                            <img id="detail-toAvatar" src="" alt="Avatar" class="rounded-circle d-none" style="width: 40px; height: 40px; object-fit: cover;" onerror="this.style.display='none'">
                            <span id="detail-toNameText"></span>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Nội dung</label>
                        <div id="detail-content" class="form-control bg-light" style="min-height: 80px; white-space: pre-wrap;"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Địa điểm</label>
                        <div id="detail-location" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Thời gian</label>
                        <div id="detail-time" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Ngày tạo</label>
                        <div id="detail-created" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Ngày cập nhật</label>
                        <div id="detail-updated" class="form-control bg-light"></div>
                    </div>
                    <div class="col-md-12" id="cancel-reason-section" style="display: none;">
                        <label class="form-label text-danger">Lý do hủy</label>
                        <div id="detail-cancelReason" class="form-control bg-light border-danger" style="min-height: 60px; white-space: pre-wrap;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
    </div>

@section Scripts {
    <script>
        var appointmentsTable;

        // Appointment status mapping - sử dụng từ mappingStatus.js
        // Nếu cần format khác, có thể tạo biến local
        const appointmentStatusMappingLocal = {
            1: '<span class="badge bg-primary">Đã gửi</span>',
            2: '<span class="badge bg-success">Đã xác nhận</span>',
            3: '<span class="badge bg-danger">Đã hủy</span>'
        };

        $(document).ready(function () {
            GetListAppointments();
            $('#search').on('input', handleSearchInput);
            
            // Setup scroll for filter dropdowns
            setupSelectScroll(document.getElementById('filter-status'));
        });
        
        function setupSelectScroll(selectElement) {
            if (!selectElement) return;
            
            const maxVisibleOptions = 5;
            const totalOptions = selectElement.options.length;
            
            if (totalOptions > maxVisibleOptions) {
                $(selectElement).on('focus', function() {
                    if (this.size === 0 || this.size === 1) {
                        this.size = Math.min(maxVisibleOptions, totalOptions);
                        this.style.position = 'relative';
                        this.style.zIndex = '1000';
                    }
                });
                
                $(selectElement).on('blur', function() {
                    this.size = 0;
                    this.style.position = '';
                    this.style.zIndex = '';
                });
                
                $(selectElement).on('change', function() {
                    setTimeout(() => {
                        this.size = 0;
                        this.style.position = '';
                        this.style.zIndex = '';
                    }, 100);
                });
            }
        }

        function handleSearchInput() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                appointmentsTable.ajax.reload();
            }, 500);
        }

        function resetFilters() {
            $('#search').val('');
            $('#filter-status').val('');
            appointmentsTable.ajax.reload();
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function GetListAppointments() {
            appointmentsTable = new DataTable('#list-appointments', {
                searching: false,
                sort: false,
                responsive: true,
                pageLength: 10,
                serverSide: true,
                ajax: function (data, callback, settings) {
                    const page = (data.start / data.length) + 1;
                    const pageSize = data.length;
                    const keyword = $('#search').val();
                    const status = $('#filter-status').val();

                    $.ajax({
                        // NOTE: API cần cung cấp bởi BE
                        url: '/Appointment/GetPage',
                        type: 'GET',
                        data: {
                            page: page,
                            pageSize: pageSize,
                            keyword: keyword,
                            status: status ? parseInt(status) : null
                        },
                        success: function (response) {
                            const items = response.data || [];
                            const formattedData = items.map((apt, index) => {
                                // Format người gửi với avatar
                                let fromHtml = apt.appointmentFromName || apt.appointmentFromId || 'N/A';
                                if (apt.appointmentFromAvatar) {
                                    fromHtml = `<div class="d-flex align-items-center gap-2">
                                        <img src="${apt.appointmentFromAvatar}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover;" onerror="this.style.display='none'">
                                        <span>${apt.appointmentFromName || apt.appointmentFromId || 'N/A'}</span>
                                    </div>`;
                                }
                                
                                // Format người nhận với avatar
                                let toHtml = apt.appointmentToName || apt.appointmentToId || 'N/A';
                                if (apt.appointmentToAvatar) {
                                    toHtml = `<div class="d-flex align-items-center gap-2">
                                        <img src="${apt.appointmentToAvatar}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover;" onerror="this.style.display='none'">
                                        <span>${apt.appointmentToName || apt.appointmentToId || 'N/A'}</span>
                                    </div>`;
                                }
                                
                                return {
                                    index: data.start + index + 1,
                                    name: apt.name || '',
                                    groupName: apt.groupName || apt.groupId || 'N/A',
                                    from: fromHtml,
                                    to: toHtml,
                                    time: formatDateTime(apt.time),
                                    location: apt.location || '',
                                    status: apt.statusText 
                                        ? `<span class="badge bg-${apt.status === 1 ? 'primary' : apt.status === 2 ? 'success' : 'danger'}">${apt.statusText}</span>`
                                        : (appointmentStatusMappingLocal[apt.status] || '<span class="badge bg-secondary">Không xác định</span>'),
                                    createdDate: formatDateTime(apt.createdDate),
                                    actions: `<button class="btn btn-sm btn-info" onclick="viewAppointmentDetail('${apt.id}')"><i class='ri-eye-line'></i> Xem</button>`
                                };
                            });

                            callback({
                                data: formattedData,
                                recordsTotal: response.totalCount || items.length,
                                recordsFiltered: response.totalCount || items.length
                            });
                        },
                        error: function () {
                            callback({ data: [], recordsTotal: 0, recordsFiltered: 0 });
                        }
                    });
                },
                columns: [
                    { title: 'STT', data: 'index', className: 'text-center', width: '60px' },
                    { title: 'Tên', data: 'name', className: 'col-2' },
                    { title: 'Nhóm', data: 'groupName', className: 'text-center', width: '140px' },
                    { 
                        title: 'Từ (Người gửi)', 
                        data: 'from', 
                        className: 'text-left', 
                        width: '200px',
                        render: function(data) { return data; }
                    },
                    { 
                        title: 'Tới (Người nhận)', 
                        data: 'to', 
                        className: 'text-left', 
                        width: '200px',
                        render: function(data) { return data; }
                    },
                    { title: 'Thời gian', data: 'time', className: 'text-center', width: '140px' },
                    { title: 'Địa điểm', data: 'location', className: 'col-2' },
                    { 
                        title: 'Trạng thái', 
                        data: 'status', 
                        className: 'text-center', 
                        width: '110px',
                        render: function(data) { return data; }
                    },
                    { title: 'Ngày tạo', data: 'createdDate', className: 'text-center', width: '140px' },
                    { 
                        title: 'Thao tác', 
                        data: 'actions', 
                        className: 'text-center', 
                        width: '100px',
                        render: function(data) { return data; }
                    }
                ],
                language: {
                    lengthMenu: 'Hiển thị _MENU_ dòng mỗi trang',
                    zeroRecords: 'Không tìm thấy kết quả',
                    info: 'Hiển thị từ _START_ đến _END_ của _TOTAL_ dòng',
                    infoEmpty: 'Không có dữ liệu',
                    infoFiltered: '(lọc từ tổng số _MAX_ dòng)'
                }
            });
        }

        function viewAppointmentDetail(id) {
            $.ajax({
                url: `/Appointment/GetById/${id}`,
                type: 'GET',
                success: function (response) {
                    if (!response.success) {
                        toastr.error(response.message || 'Không tải được chi tiết lịch hẹn');
                        return;
                    }

                    const apt = response.data || {};

                    // Fill basic information
                    $('#detail-name').text(apt.name || 'N/A');
                    $('#detail-groupName').text(apt.groupName || apt.groupId || 'N/A');
                    
                    // Fill người gửi với avatar
                    const fromName = apt.appointmentFromName || apt.appointmentFromId || 'N/A';
                    $('#detail-fromNameText').text(fromName);
                    if (apt.appointmentFromAvatar) {
                        $('#detail-fromAvatar').attr('src', apt.appointmentFromAvatar).removeClass('d-none');
                    } else {
                        $('#detail-fromAvatar').addClass('d-none');
                    }
                    
                    // Fill người nhận với avatar
                    const toName = apt.appointmentToName || apt.appointmentToId || 'N/A';
                    $('#detail-toNameText').text(toName);
                    if (apt.appointmentToAvatar) {
                        $('#detail-toAvatar').attr('src', apt.appointmentToAvatar).removeClass('d-none');
                    } else {
                        $('#detail-toAvatar').addClass('d-none');
                    }
                    
                    $('#detail-content').text(apt.content || 'Không có nội dung');
                    $('#detail-location').text(apt.location || 'N/A');
                    $('#detail-time').text(formatDateTime(apt.time));
                    $('#detail-created').text(formatDateTime(apt.createdDate));
                    $('#detail-updated').text(formatDateTime(apt.updatedDate));

                    // Status with badge - sử dụng StatusText từ DTO
                    const statusBadge = apt.statusText 
                        ? `<span class="badge bg-${apt.status === 1 ? 'primary' : apt.status === 2 ? 'success' : 'danger'}">${apt.statusText}</span>`
                        : (appointmentStatusMappingLocal[apt.status] || '<span class="badge bg-secondary">Không xác định</span>');
                    $('#detail-status').html(statusBadge);

                    // Show/hide cancel reason section
                    if (apt.status === 3 && apt.cancelReason) {
                        $('#detail-cancelReason').text(apt.cancelReason);
                        $('#cancel-reason-section').show();
                    } else {
                        $('#cancel-reason-section').hide();
                    }

                    const modal = new bootstrap.Modal(document.getElementById('appointmentDetailModal'));
                    modal.show();
                },
                error: function (xhr, status, error) {
                    console.error('Error loading appointment detail:', error);
                    toastr.error('Không tải được chi tiết lịch hẹn');
                }
            });
        }
    </script>
}