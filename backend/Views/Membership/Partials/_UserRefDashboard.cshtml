<div class="modal-content border-0 shadow-lg" style="max-width: 1200px;">
    <!-- Header -->
    <div class="modal-header border-0 bg-gradient-primary text-white">
        <h5 class="modal-title fw-bold">
            <i class="ri-dashboard-line me-2"></i>
            Dashboard Trao Ref - <span class="user-name">Loading...</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <!-- Body -->
    <div class="modal-body p-4">
        <!-- User Info Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img src="/images/user.png" alt="Avatar" class="rounded-circle user-avatar"
                                     style="width: 60px; height: 60px; object-fit: cover;"
                                     onerror="this.src='/images/no-image.png'">
                            </div>
                            <div class="col">
                                <h5 class="mb-1 user-name">Loading...</h5>
                                <p class="text-muted mb-0 user-phone">Loading...</p>
                                <small class="text-muted user-company">Loading...</small>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-primary user-join-date">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="ri-send-plane-line text-success fs-2"></i>
                        <h4 class="text-success total-refs-given">0</h4>
                        <p class="text-muted mb-0">Ref đã trao</p>
                        <small class="text-success completed-refs-given">0 hoàn thành</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="ri-inbox-line text-info fs-2"></i>
                        <h4 class="text-info total-refs-received">0</h4>
                        <p class="text-muted mb-0">Ref đã nhận</p>
                        <small class="text-info completed-refs-received">0 hoàn thành</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <i class="ri-percent-line text-warning fs-2"></i>
                        <h4 class="text-warning success-rate">0%</h4>
                        <p class="text-muted mb-0">Tỷ lệ thành công</p>
                        <small class="text-warning">Khi trao ref</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="ri-money-dollar-circle-line text-primary fs-2"></i>
                        <h4 class="text-primary total-value">0</h4>
                        <p class="text-muted mb-0">Tổng giá trị</p>
                        <small class="text-primary average-value">0 trung bình</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for detailed views -->
        <ul class="nav nav-tabs" id="refTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="refs-given-tab" data-bs-toggle="tab"
                        data-bs-target="#refs-given" type="button" role="tab">
                    <i class="ri-send-plane-line me-1"></i>Ref đã trao (<span class="refs-given-count">0</span>)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="refs-received-tab" data-bs-toggle="tab"
                        data-bs-target="#refs-received" type="button" role="tab">
                    <i class="ri-inbox-line me-1"></i>Ref đã nhận (<span class="refs-received-count">0</span>)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monthly-trend-tab" data-bs-toggle="tab"
                        data-bs-target="#monthly-trend" type="button" role="tab">
                    <i class="ri-line-chart-line me-1"></i>Xu hướng tháng
                </button>
            </li>
        </ul>

        <div class="tab-content" id="refTabsContent">
            <!-- Refs Given Tab -->
            <div class="tab-pane fade show active" id="refs-given" role="tabpanel">
                <div class="table-responsive mt-3">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Người nhận</th>
                                <th class="text-center">Nội dung</th>
                                <th class="text-center">Giá trị</th>
                                <th class="text-center">Trạng thái</th>
                                <th class="text-center">Ngày tạo</th>
                            </tr>
                        </thead>
                        <tbody id="refs-given-table">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="ri-loader-4-line ri-spin fs-1"></i>
                                    <p class="mb-0">Đang tải dữ liệu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Refs Received Tab -->
            <div class="tab-pane fade" id="refs-received" role="tabpanel">
                <div class="table-responsive mt-3">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Người trao</th>
                                <th class="text-center">Nội dung</th>
                                <th class="text-center">Giá trị</th>
                                <th class="text-center">Trạng thái</th>
                                <th class="text-center">Ngày tạo</th>
                            </tr>
                        </thead>
                        <tbody id="refs-received-table">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="ri-loader-4-line ri-spin fs-1"></i>
                                    <p class="mb-0">Đang tải dữ liệu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Trend Tab -->
            <div class="tab-pane fade" id="monthly-trend" role="tabpanel">
                <div class="mt-3">
                    <!-- Chart Controls -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Loại dữ liệu:</label>
                            <select id="chartDataType" class="form-select">
                                <option value="count">Số lượng Ref</option>
                                <option value="value">Giá trị Ref</option>
                                <option value="success">Tỷ lệ thành công</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Khoảng thời gian:</label>
                            <select id="chartTimeRange" class="form-select">
                                <option value="6">6 tháng gần nhất</option>
                                <option value="12" selected>12 tháng gần nhất</option>
                                <option value="24">24 tháng gần nhất</option>
                                <option value="all">Tất cả</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Loại chart:</label>
                            <select id="chartType" class="form-select">
                                <option value="line">Đường</option>
                                <option value="bar" selected>Cột</option>
                                @* <option value="area">Vùng</option> *@
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hành động:</label>
                            <button type="button" class="btn btn-primary btn-sm" onclick="window.UserRefDashboard.updateChart()">
                                <i class="ri-refresh-line me-1"></i>Cập nhật
                            </button>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="monthlyChart" width="400" height="200"></canvas>
                    </div>

                    <!-- Chart Summary -->
                    @* <div class="row mt-3" id="chartSummary">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Tổng Ref đã trao</h6>
                                    <h4 class="text-primary" id="totalRefsGiven">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Tổng Ref đã nhận</h6>
                                    <h4 class="text-info" id="totalRefsReceived">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Tỷ lệ thành công</h6>
                                    <h4 class="text-success" id="overallSuccessRate">0%</h4>
                                </div>
                            </div>
                        </div>
                    </div> *@
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="ri-close-line me-1"></i>
            Đóng
        </button>
        <button type="button" class="btn btn-primary" onclick="window.UserRefDashboard.exportUserRefData()">
            <i class="ri-file-excel-line me-1"></i>
            Xuất Excel
        </button>
    </div>
</div>

<script>
    // Use namespace to avoid conflicts
    window.UserRefDashboard = window.UserRefDashboard || {};
    window.UserRefDashboard.currentUserZaloId = '';

    // Initialize chart when modal is shown
    $('#membershipModal').on('shown.bs.modal', function() {
        setTimeout(() => {
            window.UserRefDashboard.initializeMonthlyChart();
        }, 300);
    });

    // Initialize chart when monthly trend tab is clicked
    $('#monthly-trend-tab').on('click', function() {
        setTimeout(() => {
            window.UserRefDashboard.initializeMonthlyChart();
        }, 100);
    });

    window.UserRefDashboard.initializeMonthlyChart = function() {
        const ctx = document.getElementById('monthlyChart');
        if (!ctx) {
            console.log('Chart canvas not found');
            return;
        }

        // Destroy existing chart if it exists
        if (window.monthlyChartInstance) {
            window.monthlyChartInstance.destroy();
            window.monthlyChartInstance = null;
        }

        console.log('Initializing chart with data:', window.monthlyData);

        // Get chart configuration from controls
        const dataType = document.getElementById('chartDataType')?.value || 'count';
        const timeRange = document.getElementById('chartTimeRange')?.value || '12';
        const chartType = document.getElementById('chartType')?.value || 'bar';

        // Filter data based on time range
        let filteredData = window.monthlyData || [];
        if (timeRange !== 'all' && filteredData.length > 0) {
            const months = parseInt(timeRange);
            const now = new Date();
            const cutoffDate = new Date(now.getFullYear(), now.getMonth() - months, 1);

            filteredData = filteredData.filter(item => {
                const itemDate = new Date(item.year, item.monthNumber - 1, 1);
                return itemDate >= cutoffDate;
            });
        }

        if (filteredData && Array.isArray(filteredData) && filteredData.length > 0) {
            try {
                // Prepare data based on selected type
                let datasets = [];
                let yAxisLabel = '';

                if (dataType === 'count') {
                    datasets = [{
                        label: 'Ref đã trao',
                        data: filteredData.map(item => item.refsGiven || 0),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: chartType === 'area'
                    }, {
                        label: 'Ref đã nhận',
                        data: filteredData.map(item => item.refsReceived || 0),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: chartType === 'area'
                    }];
                    yAxisLabel = 'Số lượng Ref';
                } else if (dataType === 'value') {
                    datasets = [{
                        label: 'Giá trị Ref đã trao',
                        data: filteredData.map(item => item.valueGiven || 0),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: chartType === 'area'
                    }, {
                        label: 'Giá trị Ref đã nhận',
                        data: filteredData.map(item => item.valueReceived || 0),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: chartType === 'area'
                    }];
                    yAxisLabel = 'Giá trị (VNĐ)';
                } else if (dataType === 'success') {
                    datasets = [{
                        label: 'Tỷ lệ thành công',
                        data: filteredData.map(item => item.successRate || 0),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        fill: chartType === 'area'
                    }];
                    yAxisLabel = 'Tỷ lệ (%)';
                }

                const chartConfig = {
                    type: chartType,
                    data: {
                        labels: filteredData.map(item => item.month || 'N/A'),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: yAxisLabel
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (dataType === 'value') {
                                            return value.toLocaleString('vi-VN') + ' VNĐ';
                                        } else if (dataType === 'success') {
                                            return value + '%';
                                        }
                                        return value;
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tháng'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: `Thống kê Ref - ${yAxisLabel}`,
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        let value = context.parsed.y;

                                        if (dataType === 'value') {
                                            value = value.toLocaleString('vi-VN') + ' VNĐ';
                                        } else if (dataType === 'success') {
                                            value = value + '%';
                                        }

                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                };

                // Special handling for bar chart
                if (chartType === 'bar') {
                    chartConfig.options.scales.x.barPercentage = 0.8;
                    chartConfig.options.scales.x.categoryPercentage = 0.8;
                }

                window.monthlyChartInstance = new Chart(ctx.getContext('2d'), chartConfig);
                console.log('Chart initialized successfully with type:', chartType, 'dataType:', dataType);

                // Update summary cards
                window.UserRefDashboard.updateChartSummary(filteredData);
            } catch (error) {
                console.error('Error initializing chart:', error);
            }
        } else {
            // Show message when no data
            const canvas = ctx;
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = '#666';
            context.font = '16px Arial';
            context.textAlign = 'center';
            context.fillText('Không có dữ liệu để hiển thị', canvas.width / 2, canvas.height / 2);
            console.log('No data available for chart, monthlyData:', window.monthlyData);
        }
    }

    window.UserRefDashboard.exportUserRefData = function() {
        if (window.UserRefDashboard.currentUserZaloId) {
            window.open(`/api/dashboard/export-user-refs/${window.UserRefDashboard.currentUserZaloId}`, '_blank');
        }
    }

    // Update chart function
    window.UserRefDashboard.updateChart = function() {
        window.UserRefDashboard.initializeMonthlyChart();
    }

    // Update chart summary cards
    window.UserRefDashboard.updateChartSummary = function(data) {
        if (!data || data.length === 0) return;

        const totalRefsGiven = data.reduce((sum, item) => sum + (item.refsGiven || 0), 0);
        const totalRefsReceived = data.reduce((sum, item) => sum + (item.refsReceived || 0), 0);
        const totalCompletedRefsGiven = data.reduce((sum, item) => sum + (item.completedRefsGiven || 0), 0);
        const totalCompletedRefsReceived = data.reduce((sum, item) => sum + (item.completedRefsReceived || 0), 0);

        const overallSuccessRate = totalRefsGiven > 0 ? (totalCompletedRefsGiven / totalRefsGiven * 100) : 0;

        document.getElementById('totalRefsGiven').textContent = totalRefsGiven.toLocaleString();
        document.getElementById('totalRefsReceived').textContent = totalRefsReceived.toLocaleString();
        document.getElementById('overallSuccessRate').textContent = overallSuccessRate.toFixed(1) + '%';
    }

    // Add event listeners for chart controls
    $(document).ready(function() {
        $('#chartDataType, #chartTimeRange, #chartType').on('change', function() {
            window.UserRefDashboard.updateChart();
        });
    });

    // Function to set user data (called from parent)
    window.setUserRefData = function(data) {
        console.log('setUserRefData called with data:', data);

        // Check if data has the expected structure
        if (!data || !data.summary) {
            console.error('Invalid data structure:', data);
            return;
        }

        window.UserRefDashboard.currentUserZaloId = data.userZaloId;

        // Fill user info
        $('.user-name').text(data.fullname || 'N/A');
        $('.user-phone').text(data.phoneNumber || 'N/A');
        $('.user-company').text(data.company || 'Chưa có công ty');
        $('.user-join-date').text(`Thành viên từ ${data.createdDate ? new Date(data.createdDate).toLocaleDateString('vi-VN') : 'N/A'}`);
        $('.user-avatar').attr('src', data.avatar || '/images/user.png');

        // Fill summary cards
        $('.total-refs-given').text(data.summary.totalRefsGiven || 0);
        $('.completed-refs-given').text(`${data.summary.completedRefsGiven || 0} hoàn thành`);
        $('.total-refs-received').text(data.summary.totalRefsReceived || 0);
        $('.completed-refs-received').text(`${data.summary.completedRefsReceived || 0} hoàn thành`);

        // Calculate success rate based on completed refs vs total refs given
        const successRate = data.summary.totalRefsGiven > 0
            ? ((data.summary.completedRefsGiven || 0) / (data.summary.totalRefsGiven || 1)) * 100
            : 0;
        $('.success-rate').text(`${successRate.toFixed(1)}%`);

        $('.total-value').text((data.summary.totalValueGiven || 0).toLocaleString());
        $('.average-value').text(`${(data.summary.averageValueGiven || 0).toLocaleString()} trung bình`);

        // Fill tab counts
        $('.refs-given-count').text((data.refsGiven || []).length);
        $('.refs-received-count').text((data.refsReceived || []).length);

        // Fill tables
        fillRefsTable('#refs-given-table', data.refsGiven || []);
        fillRefsTable('#refs-received-table', data.refsReceived || []);

        // Set monthly data for chart
        window.monthlyData = data.monthlyData || [];
        console.log('Monthly data set:', window.monthlyData);

        // Force chart initialization if monthly trend tab is active
        if ($('#monthly-trend-tab').hasClass('active')) {
            setTimeout(() => {
                window.UserRefDashboard.initializeMonthlyChart();
            }, 200);
        }

        // Initialize chart
        setTimeout(() => {
            window.UserRefDashboard.initializeMonthlyChart();
        }, 100);
    }

    function fillRefsTable(tableId, refs) {
        const tbody = $(tableId);
        tbody.empty();

        if (refs && refs.length > 0) {
            refs.forEach(ref => {
                const row = `
                    <tr>
                        <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="me-2">
                                    <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center"
                                         style="width: 32px; height: 32px; color: white; font-weight: bold; font-size: 12px;">
                                        ${ref.refToName ? ref.refToName.charAt(0) : (ref.refFromName ? ref.refFromName.charAt(0) : 'U')}
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-semibold">${ref.refToName || ref.refFromName || 'Unknown'}</div>
                                    <small class="text-muted">${ref.refToPhone || ref.refFromPhone || ''}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">${ref.content}</td>
                        <td class="text-center fw-semibold">${ref.value ? ref.value.toLocaleString() : 'Chưa cập nhật'}</td>
                        <td class="text-center">
                            <span class="badge bg-${getStatusClass(ref.status)}">
                                ${ref.statusText}
                            </span>
                        </td>
                        <td class="text-center">${ref.createdDate ? new Date(ref.createdDate).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        } else {
            tbody.append(`
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="ri-inbox-line fs-1"></i>
                        <p class="mb-0">Chưa có ref nào</p>
                    </td>
                </tr>
            `);
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'Sent': return 'warning';
            case 'Received': return 'info';
            case 'Completed': return 'success';
            default: return 'secondary';
        }
    }
</script>
