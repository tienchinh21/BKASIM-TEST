@model MiniAppGIBA.Models.DTOs.Groups.MembershipGroupDTO

<div class="modal-content border-0 shadow-lg">
    <!-- Header -->
    <div class="modal-header border-0 bg-info text-white">
        <h5 class="modal-title fw-bold">
            <i class="ri-information-line me-2"></i>
            Chi tiết đơn xin tham gia
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <!-- Body -->
    <div class="modal-body p-4">
        <div class="row g-4">
            <!-- Thông tin thành viên -->
            <div class="col-12">
                <h6 class="text-primary mb-3">
                    <i class="ri-user-line me-2"></i>
                    Thông tin thành viên
                </h6>
                <div class="card bg-light">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Họ và tên</label>
                                <p class="fw-semibold mb-0">@Model.MemberName</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Hội nhóm</label>
                                <p class="fw-semibold mb-0">@Model.GroupName</p>
                            </div>
                            @{
                                var fullMembership = ViewBag.FullMembership as MiniAppGIBA.Models.DTOs.Memberships.MembershipDTO;
                            }
                            @if (fullMembership != null)
                            {
                                <div class="col-md-6">
                                    <label class="text-muted small">Số điện thoại</label>
                                    <p class="mb-0">@(fullMembership.PhoneNumber ?? "Chưa có")</p>
                                </div>
                            }

                            <div class="col-12">
                                <label class="text-muted small">Lý do tham gia</label>
                                <p class="mb-0">@(Model.Reason ?? "Chưa có")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Fields Section -->
            <div class="col-12" id="customFieldsSection" style="display: none;">
                <h6 class="text-primary mb-3">
                    <i class="ri-file-list-line me-2"></i>
                    Thông tin form tùy chỉnh
                </h6>
                <div id="customFieldsContainer">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Trạng thái -->
            <div class="col-12">
                <h6 class="text-primary mb-3">
                    <i class="ri-checkbox-circle-line me-2"></i>
                    Trạng thái phê duyệt
                </h6>
                <div class="card bg-light">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Trạng thái</label>
                                <p class="mb-0">
                                    <span class="badge bg-@Model.StatusClass">@Model.StatusText</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Ngày tạo</label>
                                <p class="mb-0">@Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                            @if (Model.ApprovedDate.HasValue)
                            {
                                <div class="col-md-6">
                                    <label class="text-muted small">Ngày phê duyệt</label>
                                    <p class="mb-0">@Model.ApprovedDate.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.RejectReason))
                            {
                                <div class="col-12">
                                    <label class="text-muted small">Lý do từ chối</label>
                                    <div class="alert alert-danger mb-0">
                                        <i class="ri-error-warning-line me-2"></i>
                                        @Model.RejectReason
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="ri-close-line me-1"></i>
            Đóng
        </button>
        @if (Model.IsApproved == null)
        {
            <button type="button" class="btn btn-danger" onclick="rejectFromDetail('@Model.Id', '@Model.MemberName')">
                <i class="ri-close-line me-1"></i>
                Từ chối
            </button>
            <button type="button" class="btn btn-success" onclick="showApprovalOptions('@Model.Id', '@Model.MemberName')">
                <i class="ri-check-line me-1"></i>
                Phê duyệt
            </button>
        }
    </div>
</div>

<script>
    // Load custom field values when modal is shown
    $(document).ready(function () {
        const membershipGroupId = '@Model.Id';
        loadCustomFieldValues(membershipGroupId);
    });

    function loadCustomFieldValues(membershipGroupId) {
        $.ajax({
            url: `/Membership/GetCustomFieldValues/${membershipGroupId}`,
            type: 'GET',
            success: function (response) {
                if (response.success && response.data.hasCustomFields) {
                    displayCustomFieldValues(response.data);
                } else {
                    // Hide custom fields section if no data
                    $('#customFieldsSection').hide();
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading custom field values:', error);
                $('#customFieldsSection').hide();
            }
        });
    }

    function displayCustomFieldValues(data) {
        const container = $('#customFieldsContainer');
        container.empty();

        if (!data.tabs || data.tabs.length === 0) {
            $('#customFieldsSection').hide();
            return;
        }

        // Show the custom fields section
        $('#customFieldsSection').show();

        // Create accordion for tabs
        const accordionHtml = data.tabs.map((tab, index) => {
            const tabValues = tab.values || [];
            const valuesHtml = tabValues.length > 0
                ? tabValues.map(value => `
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="text-muted small">
                                <i class="ri-file-text-line me-1"></i>
                                ${escapeHtml(value.fieldName)}
                            </label>
                        </div>
                        <div class="col-md-8">
                            <p class="mb-0 fw-semibold">
                                ${escapeHtml(value.fieldValue)}
                            </p>
                            <small class="text-muted">
                                Ngày gửi: ${new Date(value.createdDate).toLocaleString('vi-VN')}
                            </small>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-muted mb-0"><i class="ri-information-line me-1"></i>Không có dữ liệu</p>';

            return `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#tab-${index}">
                            <i class="ri-folder-line me-2"></i>
                            ${escapeHtml(tab.tabName)}
                            <span class="badge bg-secondary ms-2">${tabValues.length} trường</span>
                        </button>
                    </h2>
                    <div id="tab-${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#customFieldsAccordion">
                        <div class="accordion-body">
                            ${valuesHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        const html = `
            <div class="accordion" id="customFieldsAccordion">
                ${accordionHtml}
            </div>
        `;

        container.html(html);
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function approveFromDetail(id, memberName) {
        if (confirm(`Bạn có chắc chắn muốn phê duyệt đơn của "${memberName}"?`)) {
            $.ajax({
                url: '/Membership/Approve',
                type: 'POST',
                data: {
                    id: id,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message || 'Phê duyệt thành công');
                        $('#detailModal').modal('hide');
                        if (typeof pendingTable !== 'undefined') {
                            pendingTable.ajax.reload(null, false);
                        }
                    } else {
                        showError('Lỗi', response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi phê duyệt');
                }
            });
        }
    }

    function rejectFromDetail(id, memberName) {
        const reason = prompt(`Nhập lý do từ chối đơn của "${memberName}":`);
        if (reason !== null && reason.trim() !== '') {
            $.ajax({
                url: '/Membership/Reject',
                type: 'POST',
                data: {
                    id: id,
                    rejectReason: reason,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message || 'Từ chối thành công');
                        $('#detailModal').modal('hide');
                        if (typeof pendingTable !== 'undefined') {
                            pendingTable.ajax.reload(null, false);
                        }
                    } else {
                        showError('Lỗi', response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    showError('Lỗi', 'Có lỗi xảy ra khi từ chối');
                }
            });
        } else if (reason !== null) {
            showWarning('Cảnh báo', 'Vui lòng nhập lý do từ chối!');
        }
    }
</script>
