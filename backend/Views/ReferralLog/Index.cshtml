@{
    ViewData["Title"] = "Logs Giới Thiệu Thành Viên";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .btn-primary {
        background-color: #00BCD4;
        border-color: #00BCD4;
        border-radius: 8px;
    }

    .btn-primary:hover {
        background-color: #00ACC1;
        border-color: #00ACC1;
    }

    .card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        border-radius: 12px 12px 0 0;
        border-bottom: 1px solid #E9ECEF;
    }

    .stats-card {
        background: linear-gradient(135deg, #00BCD4 0%, #00ACC1 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .stats-card h3 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stats-card p {
        margin: 0;
        opacity: 0.9;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-2">Logs Giới Thiệu Thành Viên</h4>
                <p class="mb-0 text-muted">Theo dõi các hoạt động giới thiệu thành viên mới</p>
            </div>
            <button class="btn btn-success" onclick="exportReferralLogs()">
                <i class="ri-file-excel-line me-2"></i>Xuất Excel
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="col-md-6">
        <div class="stats-card">
            <h3 id="totalReferrals">0</h3>
            <p>Tổng số lượt giới thiệu</p>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stats-card" style="background: linear-gradient(135deg, #28A745 0%, #218838 100%);">
            <h3 id="topReferrerCount">0</h3>
            <p id="topReferrerName">Top người giới thiệu</p>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="ri-filter-3-line me-2"></i>
                    Bộ lọc
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="fromDate" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="toDate" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nhóm</label>
                        <select id="filter-group" class="form-select">
                            <option value="">Tất cả nhóm</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="referralLogsTable.ajax.reload(); loadStatistics();">
                            <i class="ri-search-line me-1"></i>Tìm kiếm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bảng dữ liệu -->
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="referralLogsTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">STT</th>
                                <th>Thời gian</th>
                                <th>Người giới thiệu</th>
                                <th>Người được giới thiệu</th>
                                <th>Nhóm</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let referralLogsTable;

        $(document).ready(function () {
            // Set default dates (last 30 days)
            const today = new Date();
            const last30Days = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            $('#toDate').val(today.toISOString().split('T')[0]);
            $('#fromDate').val(last30Days.toISOString().split('T')[0]);

            loadGroups();
            initDataTable();
            loadStatistics();
        });

        function loadGroups() {
            $.get('/Groups/GetAll', function (response) {
                if (response.success) {
                    let options = '<option value="">Tất cả nhóm</option>';
                    response.data.forEach(group => {
                        options += `<option value="${group.id}">${group.name}</option>`;
                    });
                    $('#filter-group').html(options);
                }
            });
        }

        function initDataTable() {
            referralLogsTable = $('#referralLogsTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/ReferralLog/GetPage',
                    type: 'GET',
                    data: function (d) {
                        return {
                            draw: d.draw,
                            page: (d.start / d.length) + 1,
                            pageSize: d.length,
                            fromDate: $('#fromDate').val(),
                            toDate: $('#toDate').val(),
                            groupId: $('#filter-group').val()
                        };
                    },
                    error: function (xhr, error, code) {
                        console.log('DataTable error:', error);
                        // Don't show error for empty data
                    }
                },
                columns: [
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            return meta.row + meta.settings._iDisplayStart + 1;
                        }
                    },
                    {
                        data: 'createdDate',
                        render: function (data) {
                            return new Date(data).toLocaleString('vi-VN');
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            return `<div>
                                        <div class="fw-semibold">${data.referrerFullName || 'N/A'}</div>
                                        <small class="text-muted">${data.referrerPhoneNumber || ''}</small>
                                    </div>`;
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            return `<div>
                                        <div class="fw-semibold">${data.referredFullName || 'N/A'}</div>
                                        <small class="text-muted">${data.referredPhoneNumber || ''}</small>
                                    </div>`;
                        }
                    },
                    { data: 'groupName' }
                ],
                language: {
                    "sProcessing": "Đang xử lý...",
                    "sLengthMenu": "Hiển thị _MENU_ mục",
                    "sZeroRecords": "Không tìm thấy dữ liệu",
                    "sInfo": "Hiển thị từ _START_ đến _END_ của _TOTAL_ dòng",
                    "sInfoEmpty": "Hiển thị từ 0 đến 0 trong tổng số 0 mục (lọc từ NaN mục)",
                    "sInfoFiltered": "(lọc từ _MAX_ mục)",
                    "sSearch": "Tìm kiếm:",
                    "oPaginate": {
                        "sFirst": "Đầu",
                        "sPrevious": "Trước",
                        "sNext": "Tiếp",
                        "sLast": "Cuối"
                    }
                },
                pagingType: "full_numbers",
                pageLength: 10,
                order: [[1, 'desc']]
            });
        }

        function loadStatistics() {
            const fromDate = $('#fromDate').val();
            const toDate = $('#toDate').val();
            const groupId = $('#filter-group').val();

            $.get(`/ReferralLog/GetTopReferrers?fromDate=${fromDate}&toDate=${toDate}&groupId=${groupId || ''}`, function (response) {
                if (response.success && response.data.length > 0) {
                    const total = response.data.reduce((sum, item) => sum + item.count, 0);
                    $('#totalReferrals').text(total);

                    const topReferrer = response.data[0];
                    $('#topReferrerCount').text(topReferrer.count);
                    $('#topReferrerName').text(topReferrer.referrerFullName || 'N/A');
                } else {
                    $('#totalReferrals').text('0');
                    $('#topReferrerCount').text('0');
                    $('#topReferrerName').text('Chưa có dữ liệu');
                }
            });
        }

        function exportReferralLogs() {
            const fromDate = $('#fromDate').val();
            const toDate = $('#toDate').val();
            const groupId = $('#filter-group').val();

            let url = `/ReferralLog/Export?fromDate=${fromDate}&toDate=${toDate}`;
            if (groupId) {
                url += `&groupId=${groupId}`;
            }

            window.location.href = url;
        }
    </script>
}

