@{
    ViewData["Title"] = "Quản Lý Tài Khoản ADMIN";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Modern UI Styling */
    .btn-primary {
        background-color: #00BCD4;
        border-color: #00BCD4;
        border-radius: 8px;
    }

    .btn-primary:hover {
        background-color: #00ACC1;
        border-color: #00ACC1;
    using MiniAppGIBA.Constants;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 188, 212, 0.2);
    }

    .card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        border-radius: 12px 12px 0 0;
        border-bottom: 1px solid #E9ECEF;
    }

    .role-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .role-admin {
        background-color: #E3F2FD;
        color: #1976D2;
    }

    .role-super-admin {
        background-color: #FFF3E0;
        color: #F57C00;
    }

    .status-active {
        color: #28A745;
        font-weight: 500;
    }

    .status-inactive {
        color: #DC3545;
        font-weight: 500;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .modern-modal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
    }

    .modern-modal .modal-header {
        border-radius: 12px 12px 0 0;
        background: #F8F9FA;
    }

    .modern-modal .modal-footer {
        border-radius: 0 0 12px 12px;
        background: #F8F9FA;
    }

    .form-control:focus {
        border-color: #00BCD4;
        box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
    }

    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        color: #6C757D;
    }

    .nav-tabs .nav-link.active {
        color: #00BCD4;
        border-bottom-color: #fff;
    }
</style>
@using MiniAppGIBA.Constants;
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    var isGiba = User?.IsInRole(CTRole.GIBA) == true;
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-lg-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <div>
                <h4 class="mb-2">Danh Sách Tài Khoản</h4>
                <p class="mb-0 text-muted">Quản lý tài khoản ADMIN trong hệ thống</p>
            </div>
            @if (isGiba)
            {
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="ri-add-line me-2"></i>Thêm mới
                </button>
            }
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="ri-filter-3-line me-2"></i>
                    Bộ lọc tìm kiếm
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Thanh tìm kiếm -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <input id="search" type="text" class="form-control"
                                placeholder="Tìm theo tên, SĐT..." />
                        </div>
                    </div>

                    <!-- Nút tìm kiếm -->
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100" onclick="adminsTable.ajax.reload()">
                            <i class="ri-search-line me-1"></i>Tìm kiếm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bảng dữ liệu -->
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="adminsTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">STT</th>
                                <th>Tên Tài Khoản</th>
                                <th>Số Điện Thoại</th>
                                <th>Ngày Tạo</th>
                                <th style="width: 150px;">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade modern-modal" id="adminModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title">
                    <i class="ri-user-add-line me-2"></i>
                    <span id="modalTitle">Thêm tài khoản mới</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                        <input type="hidden" id="adminId" />
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="fullName" placeholder="Nhập họ và tên" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tên đăng nhập <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="username" placeholder="Nhập tên đăng nhập" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="phoneNumber" placeholder="Nhập số điện thoại" autocomplete="off" />
                                    <div id="phoneSuggestion" class="position-absolute w-100 bg-white border rounded shadow-sm mt-1" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Suggestion items will be inserted here -->
                                    </div>
                                    <div id="phoneError" class="invalid-feedback" style="display: none;"></div>
                                </div>
                                <small class="text-muted" id="phoneHelpText"></small>
                            </div>
                            <div class="col-md-6" id="passwordField">
                                <label class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" placeholder="••••••••" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                        <i class="ri-eye-line" id="passwordIcon"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Mật khẩu phải có ít nhất 6 ký tự</small>
                            </div>
                            <!-- Role mặc định là GIBA - không cần chọn -->
                            <input type="hidden" name="role" id="role_giba" value="GIBA" />
                            <div class="col-md-6">
                                <label class="form-label">Trạng thái</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isActive" checked />
                                    <label class="form-check-label" for="isActive">
                                        Hoạt động
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6" id="resetPasswordField" style="display: none;">
                                <label class="form-label">Đặt lại mật khẩu</label>
                                <button type="button" class="btn btn-outline-warning w-100" onclick="openResetPasswordModal()">
                                    <i class="ri-key-line me-2"></i>Đặt lại mật khẩu
                                </button>
                            </div>
                        </div>
            </div>

            <div class="modal-footer border-top">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Đóng
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAdmin()">
                    <i class="ri-save-line me-1"></i><span id="saveButtonText">Tạo tài khoản</span>
                </button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>
        // Override global alert functions BEFORE other code runs
        // This ensures they use SweetAlert 2.x instead of the swal() from app.js
        (function() {
            'use strict';
            
            // Store original functions if needed (optional)
            // var originalShowSuccess = window.showSuccess;
            // var originalShowError = window.showError;
            // var originalShowWarning = window.showWarning;
            
            // Override with SweetAlert 2.x implementations
            window.showSuccess = function(title, message) {
                if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                    Swal.fire({
                        title: title || 'Thành công',
                        text: message || '',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#3085d6'
                    });
                } else {
                    // Fallback to native alert
                    alert((title || 'Thành công') + ': ' + (message || ''));
                }
            };
            
            window.showError = function(title, message) {
                if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                    Swal.fire({
                        title: title || 'Lỗi',
                        text: message || '',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#d33'
                    });
                } else {
                    // Fallback to native alert
                    alert((title || 'Lỗi') + ': ' + (message || ''));
                }
            };
            
            window.showWarning = function(title, message) {
                if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                    Swal.fire({
                        title: title || 'Cảnh báo',
                        text: message || '',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#f0ad4e'
                    });
                } else {
                    // Fallback to native alert
                    alert((title || 'Cảnh báo') + ': ' + (message || ''));
                }
            };
        })();
        
        let adminsTable;

        $(document).ready(function () {
            // Override alert functions AFTER all scripts are loaded
            // This ensures they override the functions from _Layout.cshtml script block
            window.showSuccess = function(title, message) {
                if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                    Swal.fire({
                        title: title || 'Thành công',
                        text: message || '',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#3085d6'
                    });
                } else {
                    alert((title || 'Thành công') + ': ' + (message || ''));
                }
            };
            
            window.showError = function(title, message) {
                if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                    Swal.fire({
                        title: title || 'Lỗi',
                        text: message || '',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#d33'
                    });
                } else {
                    alert((title || 'Lỗi') + ': ' + (message || ''));
                }
            };
            
            window.showWarning = function(title, message) {
                if (typeof Swal !== 'undefined' && typeof Swal.fire === 'function') {
                    Swal.fire({
                        title: title || 'Cảnh báo',
                        text: message || '',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#f0ad4e'
                    });
                } else {
                    alert((title || 'Cảnh báo') + ': ' + (message || ''));
                }
            };
            
            initDataTable();
            
            // Initialize search with debounce
            let searchTimeout;
            $('#search').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (adminsTable) {
                        adminsTable.ajax.reload();
                    }
                }, 500);
            });
        });

        function initDataTable() {
            adminsTable = $('#adminsTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/AdminManagement/GetPage',
                    type: 'POST',
                    data: function (d) {
                        return {
                            draw: d.draw,
                            page: (d.start / d.length) + 1,
                            pageSize: d.length,
                            keyword: $('#search').val(),
                            role: $('#filter-role').val()
                        };
                    },
                    error: function (xhr, error, code) {
                        console.log('DataTable error:', error);
                        // Don't show error for empty data
                    }
                },
                columns: [
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            return meta.row + meta.settings._iDisplayStart + 1;
                        }
                    },
                    { data: 'fullName' },
                    { data: 'phoneNumber' },
                    { data: 'createdDate' },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            let buttons = '';
                            buttons += `<button class="btn btn-sm btn-icon btn-primary me-1" onclick="editAdmin('${row.id}')" title="Chỉnh sửa">
                                            <i class="ri-edit-line"></i>
                                        </button>`;
                            return buttons;
                        }
                    }
                ],
                language: {
                    "sProcessing": "Đang xử lý...",
                    "sLengthMenu": "Hiển thị _MENU_ mục",
                    "sZeroRecords": "Không tìm thấy dữ liệu",
                    "sInfo": "Hiển thị _START_ đến _END_ trong tổng số _TOTAL_ mục",
                    "sInfoEmpty": "Hiển thị 0 đến 0 trong tổng số 0 mục",
                    "sInfoFiltered": "(lọc từ _MAX_ mục)",
                    "sSearch": "Tìm kiếm:",
                    "oPaginate": {
                        "sFirst": "Đầu",
                        "sPrevious": "Trước",
                        "sNext": "Tiếp",
                        "sLast": "Cuối"
                    }
                },
                pageLength: 10,
                order: [[1, 'asc']]
            });
        }

        // Debounce function
        let phoneCheckTimeout;
        function checkPhoneNumber() {
            const phoneNumber = $('#phoneNumber').val().trim();
            const adminId = $('#adminId').val(); // Chỉ check khi tạo mới, không check khi edit
            
            // Clear previous timeout
            clearTimeout(phoneCheckTimeout);
            
            // Ẩn dropdown nếu phoneNumber rỗng hoặc đang edit
            if (adminId || !phoneNumber || phoneNumber.length < 10) {
                $('#phoneSuggestion').hide();
                return;
            }
            
            // Set timeout để gọi API sau 500ms khi user dừng nhập
            phoneCheckTimeout = setTimeout(function() {
                // Encode phone number properly for URL
                const encodedPhoneNumber = encodeURIComponent(phoneNumber);
                $.get(`/api/Memberships/check-user-admin?phoneNumber=${encodedPhoneNumber}`, function(response) {
                    // Clear previous states
                    $('#phoneSuggestion').hide();
                    $('#phoneError').hide();
                    $('#phoneNumber').removeClass('is-invalid is-valid');
                    $('#phoneHelpText').text('');
                    
                    if (response.success && response.data) {
                        // Check if user is already an admin
                        if (response.data.message && response.data.message.includes('admin')) {
                            // User is already an admin
                            $('#phoneNumber').addClass('is-invalid');
                            $('#phoneError').text(response.data.message || 'Thành viên này đã là admin!').show();
                            $('#phoneHelpText').html('<span class="text-danger"><i class="ri-error-warning-line me-1"></i>Không thể tạo tài khoản cho số điện thoại này</span>');
                            return;
                        }
                        
                        // Check if userInfo exists (normal user)
                        if (response.data.userInfo) {
                            const userInfo = response.data.userInfo;
                            // Hiển thị suggestion dropdown
                            $('#phoneNumber').addClass('is-valid');
                            showPhoneSuggestion(userInfo);
                        } else {
                            // User not found or other case
                            $('#phoneNumber').removeClass('is-invalid is-valid');
                        }
                    } else {
                        // Response indicates failure or user not found
                        $('#phoneSuggestion').hide();
                        $('#phoneNumber').removeClass('is-invalid is-valid');
                    }
                }).fail(function(xhr, status, error) {
                    $('#phoneSuggestion').hide();
                    $('#phoneError').hide();
                    $('#phoneNumber').removeClass('is-invalid is-valid');
                    
                    // Only show error if it's a server error (not 404)
                    if (xhr.status >= 500) {
                        $('#phoneError').text('Lỗi khi kiểm tra số điện thoại').show();
                        $('#phoneNumber').addClass('is-invalid');
                    }
                });
            }, 500);
        }

        let currentUserInfo = null; // Lưu userInfo hiện tại

        function showPhoneSuggestion(userInfo) {
            currentUserInfo = userInfo; // Lưu userInfo để dùng khi click
            
            const avatarHtml = userInfo.avatar ? 
                `<img src="${escapeHtml(userInfo.avatar)}" alt="Avatar" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" />` :
                `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="ri-user-line"></i>
                </div>`;
            
            const suggestionHtml = `
                <div class="p-2 border-bottom suggestion-item" style="cursor: pointer; transition: background-color 0.2s;" 
                     onmouseover="this.style.backgroundColor='#f8f9fa'" 
                     onmouseout="this.style.backgroundColor='white'"
                     onclick="fillUserInfo()">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${avatarHtml}
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark">${escapeHtml(userInfo.fullname || 'N/A')}</div>
                            <div class="text-muted small">${escapeHtml(userInfo.phoneNumber || '')}</div>
                        </div>
                    </div>
                </div>
            `;
            $('#phoneSuggestion').html(suggestionHtml).show();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        function fillUserInfo() {
            if (!currentUserInfo) return;
            
            // Fill thông tin vào form
            if (currentUserInfo.fullname && !$('#fullName').val()) {
                $('#fullName').val(currentUserInfo.fullname);
            }
            // Ẩn dropdown sau khi fill
            $('#phoneSuggestion').hide();
            currentUserInfo = null; // Clear sau khi fill
        }

        // Attach event listener khi document ready
        $(document).ready(function() {
            // Check phone number khi user nhập và dừng lại
            $(document).on('input', '#phoneNumber', checkPhoneNumber);
            
            // Ẩn dropdown khi click ra ngoài
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#phoneNumber, #phoneSuggestion').length) {
                    $('#phoneSuggestion').hide();
                }
            });
        });

        function openCreateModal() {
            $('#adminId').val('');
            $('#fullName').val('');
            $('#username').val('');
            $('#phoneNumber').val('');
            $('#password').val('');
            $('#modalTitle').text('Thêm tài khoản mới');
            $('#saveButtonText').text('Tạo tài khoản');
            $('#passwordField').show();
            $('#resetPasswordField').hide();

            // Clear phone number validation states
            $('#phoneNumber').removeClass('is-invalid is-valid');
            $('#phoneSuggestion').hide();
            $('#phoneError').hide();
            $('#phoneHelpText').text('');

            $('#adminModal').modal('show');
        }

        function editAdmin(id) {
            $.get(`/AdminManagement/GetById/${id}`, function (response) {
                if (response.success) {
                    const admin = response.data;
                    $('#adminId').val(admin.id);
                    $('#fullName').val(admin.fullName);
                    $('#username').val(admin.username || '');
                    $('#phoneNumber').val(admin.phoneNumber);
                    $('#modalTitle').text('Chỉnh sửa tài khoản');
                    $('#saveButtonText').text('Cập nhật');
                    $('#passwordField').hide();
                    $('#resetPasswordField').show();
                    $('#newPassword').val('');

                    $('#adminModal').modal('show');
                } else {
                    showError('Lỗi', response.message || 'Không thể tải thông tin tài khoản');
                }
            }).fail(function() {
                showError('Lỗi', 'Không thể kết nối đến server');
            });
        }

        function saveAdmin() {
            console.log('saveAdmin called');
            const adminId = $('#adminId').val();
            const isEdit = adminId !== '';
            console.log('adminId:', adminId, 'isEdit:', isEdit);

            const data = {
                fullName: $('#fullName').val(),
                username: $('#username').val(),
                phoneNumber: $('#phoneNumber').val()
            };
            console.log('data:', data);

            if (!isEdit) {
                data.password = $('#password').val();
                data.confirmPassword = $('#password').val();
                data.role = 'GIBA'; // Mặc định là GIBA
            } else {
                data.Id = adminId;
                data.isActive = $('#isActive').is(':checked');
            }

            // Validate - check if phone number has error (user is already admin)
            if (!isEdit && $('#phoneNumber').hasClass('is-invalid') && $('#phoneError').is(':visible')) {
                showWarning('Số điện thoại không hợp lệ', $('#phoneError').text() || 'Không thể tạo tài khoản cho số điện thoại này');
                return;
            }

            // Validate
            if (!data.fullName || !data.phoneNumber) {
                showWarning('Thiếu thông tin', 'Vui lòng nhập đầy đủ họ tên và số điện thoại');
                return;
            }

            if (!isEdit) {
                if (!data.username) {
                    showWarning('Thiếu thông tin', 'Vui lòng nhập tên đăng nhập');
                    return;
                }
                if (data.username.length < 3) {
                    showWarning('Tên đăng nhập không hợp lệ', 'Tên đăng nhập phải có ít nhất 3 ký tự');
                    return;
                }
                if (!data.password || data.password.length < 6) {
                    showWarning('Mật khẩu không hợp lệ', 'Mật khẩu phải có ít nhất 6 ký tự');
                    return;
                }
            }

            const url = isEdit ? '/AdminManagement/Edit' : '/AdminManagement/Create';
            const token = $('input[name="__RequestVerificationToken"]').val();
            console.log('url:', url, 'token:', token);
            console.log('Sending data:', JSON.stringify(data));

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                headers: {
                    'RequestVerificationToken': token
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message || 'Lưu thành công');
                        $('#adminModal').modal('hide');
                        adminsTable.ajax.reload();
                    } else {
                        showError('Lỗi', response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    showError('Lỗi kết nối', 'Không thể kết nối đến server');
                }
            });
        }

        function deleteAdmin(id) {
            console.log("id: " + id);
            // Use SweetAlert 2.x if available, otherwise fallback to SweetAlert 1.x
            if (typeof Swal !== 'undefined' && Swal.fire) {
                Swal.fire({
                    title: 'Xác nhận xóa',
                    text: 'Bạn có chắc chắn muốn xóa tài khoản này?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const token = $('input[name="__RequestVerificationToken"]').val();
                        $.ajax({
                            url: `/AdminManagement/Delete/${id}`,
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: token
                            },
                            success: function (response) {
                                if (response.success) {
                                    showSuccess('Thành công', 'Xóa tài khoản thành công');
                                    adminsTable.ajax.reload();
                                } else {
                                    showError('Lỗi', response.message || 'Có lỗi xảy ra');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.log("Error deleting admin:", error);
                                showError('Lỗi kết nối', 'Không thể kết nối đến server');
                            }
                        });
                    }
                });
            } else if (typeof swal !== 'undefined') {
                // Fallback to SweetAlert 1.x
                swal({
                    title: 'Xác nhận xóa',
                    text: 'Bạn có chắc chắn muốn xóa tài khoản này?',
                    icon: 'warning',
                    buttons: {
                        cancel: {
                            text: 'Hủy',
                            visible: true,
                            className: 'btn btn-light'
                        },
                        confirm: {
                            text: 'Xóa',
                            className: 'btn btn-danger'
                        }
                    },
                    dangerMode: true
                }).then((willDelete) => {
                    if (willDelete) {
                        const token = $('input[name="__RequestVerificationToken"]').val();
                        $.ajax({
                            url: `/AdminManagement/Delete/${id}`,
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: token
                            },
                            success: function (response) {
                                if (response.success) {
                                    showSuccess('Thành công', 'Xóa tài khoản thành công');
                                    adminsTable.ajax.reload();
                                } else {
                                    showError('Lỗi', response.message || 'Có lỗi xảy ra');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.log("Error deleting admin:", error);
                                showError('Lỗi kết nối', 'Không thể kết nối đến server');
                            }
                        });
                    }
                });
            } else {
                // Final fallback to native confirm
                if (confirm('Bạn có chắc chắn muốn xóa tài khoản này?')) {
                    const token = $('input[name="__RequestVerificationToken"]').val();
                    $.ajax({
                        url: `/AdminManagement/Delete/${id}`,
                        type: 'POST',
                        data: {
                            __RequestVerificationToken: token
                        },
                        success: function (response) {
                            if (response.success) {
                                showSuccess('Thành công', 'Xóa tài khoản thành công');
                                adminsTable.ajax.reload();
                            } else {
                                showError('Lỗi', response.message || 'Có lỗi xảy ra');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log("Error deleting admin:", error);
                            showError('Lỗi kết nối', 'Không thể kết nối đến server');
                        }
                    });
                }
            }
        }

        function togglePassword() {
            const passwordInput = $('#password');
            const passwordIcon = $('#passwordIcon');

            if (passwordInput.attr('type') === 'password') {
                passwordInput.attr('type', 'text');
                passwordIcon.removeClass('ri-eye-line').addClass('ri-eye-off-line');
            } else {
                passwordInput.attr('type', 'password');
                passwordIcon.removeClass('ri-eye-off-line').addClass('ri-eye-line');
            }
        }

        function toggleNewPassword() {
            const passwordInput = $('#newPassword');
            const passwordIcon = $('#newPasswordIcon');

            if (passwordInput.attr('type') === 'password') {
                passwordInput.attr('type', 'text');
                passwordIcon.removeClass('ri-eye-line').addClass('ri-eye-off-line');
            } else {
                passwordInput.attr('type', 'password');
                passwordIcon.removeClass('ri-eye-off-line').addClass('ri-eye-line');
            }
        }

        function openResetPasswordModal() {
            const adminId = $('#adminId').val();
            const adminEmail = $('#email').val();

            if (!adminId) {
                showError('Lỗi', 'Vui lòng chọn tài khoản');
                return;
            }

            $('#resetPasswordAdminId').val(adminId);
            $('#resetPasswordEmail').text(adminEmail);
            $('#resetPasswordForm')[0].reset();
            $('#resetPasswordModal').modal('show');
        }

        function submitResetPassword() {
            const adminId = $('#resetPasswordAdminId').val();
            const newPassword = $('#newPasswordInput').val();
            const confirmPassword = $('#confirmPasswordInput').val();

            if (!newPassword || newPassword.length < 6) {
                showError('Lỗi', 'Mật khẩu phải có ít nhất 6 ký tự');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Lỗi', 'Mật khẩu xác nhận không khớp');
                return;
            }

            const token = $('input[name="__RequestVerificationToken"]').val();
            $.ajax({
                url: '/AdminManagement/ResetPassword',
                type: 'POST',
                data: {
                    id: adminId,
                    newPassword: newPassword
                },
                headers: {
                    'RequestVerificationToken': token
                },
                success: function (response) {
                    if (response.success) {
                        showSuccess('Thành công', response.message || 'Đặt lại mật khẩu thành công');
                        $('#resetPasswordModal').modal('hide');
                    } else {
                        showError('Lỗi', response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    showError('Lỗi kết nối', 'Không thể kết nối đến server');
                }
            });
        }

        function toggleResetPasswordVisibility(fieldId, iconId) {
            const field = $(`#${fieldId}`);
            const icon = $(`#${iconId}`);

            if (field.attr('type') === 'password') {
                field.attr('type', 'text');
                icon.removeClass('ri-eye-line').addClass('ri-eye-off-line');
            } else {
                field.attr('type', 'password');
                icon.removeClass('ri-eye-off-line').addClass('ri-eye-line');
            }
        }

    </script>
}

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title">
                    <i class="ri-key-line me-2"></i>
                    Đặt lại mật khẩu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#tab-password-info">
                            <i class="ri-information-line me-1"></i>Thông tin tài khoản
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tab-password-change">
                            <i class="ri-lock-line me-1"></i>Đổi mật khẩu
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Tab 1: Account Info -->
                    <div class="tab-pane fade show active" id="tab-password-info">
                        <div class="alert alert-info mb-3">
                            <i class="ri-information-line me-2"></i>
                            Bạn sắp đặt lại mật khẩu cho tài khoản dưới đây
                        </div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Email</label>
                                <p class="form-control-plaintext" id="resetPasswordEmail"></p>
                            </div>
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="ri-alert-line me-2"></i>
                                    <strong>Yêu cầu mật khẩu:</strong> Ít nhất 6 ký tự, 1 ký tự in hoa, 1 ký tự thường và 1 ký tự số
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Password Change -->
                    <div class="tab-pane fade" id="tab-password-change">
                        <form id="resetPasswordForm">
                            <input type="hidden" id="resetPasswordAdminId" />
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPasswordInput" placeholder="Nhập mật khẩu mới" required />
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleResetPasswordVisibility('newPasswordInput', 'newPasswordIcon')">
                                            <i class="ri-eye-line" id="newPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmPasswordInput" placeholder="Nhập lại mật khẩu mới" required />
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleResetPasswordVisibility('confirmPasswordInput', 'confirmPasswordIcon')">
                                            <i class="ri-eye-line" id="confirmPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="submitResetPassword()">
                    <i class="ri-save-line me-1"></i>
                    Đặt lại mật khẩu
                </button>
            </div>
        </div>
    </div>
</div>
